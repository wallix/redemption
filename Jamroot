JAM_INCLUDE_PATH ?= jam ;

include $(JAM_INCLUDE_PATH)/redemption-config.jam ;
include $(JAM_INCLUDE_PATH)/cxxflags.jam ;
include $(JAM_INCLUDE_PATH)/defines.jam ;
include $(JAM_INCLUDE_PATH)/includes.jam ;

REDEMPTION_CXXFLAGS ?= <cxxflags>-std=c++11 ;

project redemption
    : requirements

    <conditional>@includes

    <conditional>@defines

    $(CXXFLAGS)

#    <cxxflags>-fpie
    <cxxflags>-fPIC
    <variant>san:<cxxflags>-frtti # undefined reference to `typeinfo`.

    $(REDEMPTION_CXXFLAGS)

    <define>_FILE_OFFSET_BITS=64
    <define>_LARGEFILE64_SOURCE

    <define>__STDC_FORMAT_MACROS

   : default-build release
;

include $(JAM_INCLUDE_PATH)/ocr.jam ;
include $(JAM_INCLUDE_PATH)/libs.jam ;

include $(JAM_INCLUDE_PATH)/testing-coverage.jam ;

explicit
    install
    instexe
    install-bin
    install-lib
    install-share
    install-etc
    install-etc-themes
    install-etc-ppocr
    install-etc-ppocr-latin
    install-etc-ppocr-latin-cyrillic
    exe
    libs
;

alias instexe : install-bin ;
alias install :
    install-bin install-lib
    install-etc
    install-etc-themes
    install-etc-ppocr
    install-share
;
alias exe     : rdpproxy rdptproxy rdptanalyzer rdpclient vncclient rdpheadless rdpinichecker ;
alias libs    : libredrec ;

alias ocr_tools : display_learning extract_text ppocr_extract_text ;

alias install-etc-ppocr : install-etc-ppocr-latin install-etc-ppocr-latin-cyrillic ;

install install-bin
    : exe
    : <install-type>EXE
      #<install-dependencies>on
    : <location>$(INSTALLDIR)$(BIN_PREFIX)
    ;

install install-share
    : [ glob $(REDEMPTION_SYS_PATH)/share/rdpproxy/[^.k]* ]
    :
    : <location>$(INSTALLDIR)$(SHARE_PREFIX)
    ;

install install-etc
    : [ glob
        $(REDEMPTION_ETC_DH_GLOG)
    ]
    :
    : <location>$(INSTALLDIR)$(ETC_PREFIX)
    ;

install install-etc-ppocr-latin
    : [ glob $(REDEMPTION_SYS_PATH)/etc/rdpproxy/ppocr.latin/* ]
    :
    : <location>$(INSTALLDIR)$(ETC_PREFIX)/ppocr.latin
    ;

install install-etc-ppocr-latin-cyrillic
    : [ glob $(REDEMPTION_SYS_PATH)/etc/rdpproxy/ppocr.latin-cyrillic/* ]
    :
    : <location>$(INSTALLDIR)$(ETC_PREFIX)/ppocr.latin-cyrillic
    ;

install install-etc-themes
    : [ glob $(REDEMPTION_SYS_PATH)/etc/rdpproxy/themes/HOWTO ]
    :
    : <location>$(INSTALLDIR)$(ETC_PREFIX)/themes
    ;

install install-lib
    : libs
    :
    : <location>$(INSTALLDIR)$(LIB_PREFIX)
    ;


constant COMMON_OBJ_DEPENDENCIES :
    <define>SHARE_PATH='\"$(SHARE_PREFIX)\"'
    <define>CFG_PATH='\"$(ETC_PREFIX)\"'
;
constant LIB_DEPENDENCIES :
    $(COMMON_OBJ_DEPENDENCIES)
    <cxxflags>-fPIC
    <variant>release:<cxxflags>-fvisibility=hidden
    <define>REDEMPTION_DECL_LOG_SYSLOG
;
constant OBJ_EXE_DEPENDENCIES :
    $(COMMON_OBJ_DEPENDENCIES)
    $(GCOV_NO_BUILD)
;
constant EXE_DEPENDENCIES :
    $(OBJ_EXE_DEPENDENCIES)
    <define>REDEMPTION_DECL_LOG_SYSLOG
;

constant OBJ_TEST_DEPENDENCIES :
    $(GCOV)
    <library>libunit_test
    <include>$(REDEMPTION_TEST_PATH)
    <cxxflags>-frtti
    <define>FIXTURES_PATH='\"$(FIXTURES_PATH)\"'
    <define>SHARE_PATH='\"$(FIXTURES_PATH)\"'
    <define>CFG_PATH='\"$(REDEMPTION_SYS_PATH)/etc/rdpproxy/\"'
;

constant TEST_DEPENDENCIES :
    $(OBJ_TEST_DEPENDENCIES)
    $(UNIT_TEST_DEPENDENCIES)
;


obj video_capture.o : $(REDEMPTION_SRC_PATH)/capture/video_capture.cpp ;
obj bitmap_from_file.o : $(REDEMPTION_SRC_PATH)/utils/bitmap_from_file.cpp : <cxxflags>-std=c++14 ;
obj d3des.o : $(REDEMPTION_SRC_PATH)/utils/d3des.cpp ;
obj png.o : $(REDEMPTION_SRC_PATH)/utils/png.cpp ;
obj bitmap.o : $(REDEMPTION_SRC_PATH)/utils/bitmap_data_allocator.cpp ;
obj program_options.o : $(PROGRAM_OPTIONS_SRC_PATH)/program_options.cpp ;

obj mainloop : $(REDEMPTION_SRC_PATH)/core/mainloop.cpp : $(OBJ_EXE_DEPENDENCIES) ;
obj do_recorder : $(REDEMPTION_SRC_PATH)/main/do_recorder.cpp : $(OBJ_EXE_DEPENDENCIES) ;
obj capture : $(REDEMPTION_SRC_PATH)/capture/capture.cpp : $(OBJ_EXE_DEPENDENCIES) ;

obj do_recorder_test : $(REDEMPTION_SRC_PATH)/main/do_recorder.cpp : $(OBJ_TEST_DEPENDENCIES) ;
obj capture_test : $(REDEMPTION_SRC_PATH)/capture/capture.cpp : $(OBJ_TEST_DEPENDENCIES) ;

alias bitmap : bitmap.o bitmap_from_file.o png ;
alias video_capture : video_capture.o ffmpeg ;


#
# Redemption
#

exe rdpproxy
    :
        $(REDEMPTION_SRC_PATH)/main/main.cpp
        video_capture
        capture
        bitmap.o
        bitmap_from_file.o
        program_options.o
        png.o

        ocr/<link>static

        mainloop

        d3des.o

        openssl
        crypto
        z
        dl
        png

        snappy
#        lzma

        krb5
        gssglue

        rt
    :
#         <link>static
        $(EXE_DEPENDENCIES)
    ;

lib libredrec
    :
        video_capture
        capture
        do_recorder
        $(REDEMPTION_SRC_PATH)/utils/log_as_syslog.cpp
        bitmap.o
        bitmap_from_file.o
        program_options.o
        png.o

        ocr/<link>static

        openssl
        crypto
        png
        z
        dl

        snappy
    :
        <link>shared
        <linkflags>-Wl,-Bsymbolic
        $(LIB_DEPENDENCIES)
    ;

exe rdptproxy
    :
        $(REDEMPTION_SRC_PATH)/main/transparent.cpp
        video_capture
        capture
        png.o
        bitmap.o
        bitmap_from_file.o
        program_options.o

        ocr/<link>static

        openssl
        crypto
        png
        z
        dl

        snappy
#        lzma

        krb5
        gssglue
    :
#         <link>static
        $(EXE_DEPENDENCIES)
    ;

exe rdptanalyzer
    :
        $(REDEMPTION_SRC_PATH)/main/tanalyzer.cpp
        program_options.o

        openssl
        crypto
        png
        z
        dl

        snappy

        krb5
        gssglue
    :
#         <link>static
        $(EXE_DEPENDENCIES)
    ;

exe rdpclient
    : $(REDEMPTION_SRC_PATH)/main/rdp_client.cpp
        program_options.o
        bitmap.o
        openssl
        crypto
        png
        z
        dl

        snappy
        krb5
        gssglue
    :
        $(EXE_DEPENDENCIES)
    ;

exe vncclient
    : $(REDEMPTION_SRC_PATH)/main/vnc_client.cpp
        video_capture
        capture
        program_options.o
        bitmap_from_file.o
        png.o
        bitmap.o
        openssl
        d3des.o
        crypto
        png
        z
        dl

        ocr/<link>static

        snappy
        krb5
        gssglue
    :
        $(EXE_DEPENDENCIES)
    ;

exe rdpheadless
    : $(REDEMPTION_SRC_PATH)/ftests/test_client_redemption_cli/test_client_redemption_cli.cpp
        program_options.o
        bitmap.o
        openssl
        crypto
        png
        z
        dl
        snappy
        krb5
        gssglue
    :
        $(EXE_DEPENDENCIES)
    ;

exe rdpinichecker
    :
        $(REDEMPTION_SRC_PATH)/main/ini_checker.cpp
    :
        $(EXE_DEPENDENCIES)
    ;

exe redrec
    :
        $(REDEMPTION_SRC_PATH)/main/redrec.cpp
        libredrec
    :
        $(EXE_DEPENDENCIES)
        -<define>REDEMPTION_DECL_LOG_SYSLOG
    ;

exe display_learning
    :
        $(REDEMPTION_SRC_PATH)/capture/ocr/display_learning.cc
    :
        $(EXE_DEPENDENCIES)
    ;

exe extract_text
    :
         $(REDEMPTION_SRC_PATH)/capture/ocr/extract_text.cc
         ocr.o
    :
        $(EXE_DEPENDENCIES)
    ;

exe ppocr_extract_text
:
    $(REDEMPTION_SRC_PATH)/capture/ocr/ppocr_extract_text.cpp
    bitmap.o
    ocr
:
    $(EXE_DEPENDENCIES)
;


## ppocr resources {

exe ppocr_write_glyphs :
    $(PPOCR_SRC_PATH)/ppocr/write_glyphs.cpp
    ppocr
:
    $(EXE_DEPENDENCIES)
;

exe ppocr_normalize_glyphs :
    $(PPOCR_SRC_PATH)/ppocr/normalize_glyphs.cpp
    ppocr
:
    $(EXE_DEPENDENCIES)
;

exe ppocr_write_datas :
    $(PPOCR_SRC_PATH)/ppocr/write_datas.cpp
    ppocr
:
    $(EXE_DEPENDENCIES)
;


actions make_ppocr_resources {
    $(PPOCR_MODULE_PATH)/learning "$(>)"
    # latin
    cp $(PPOCR_MODULE_PATH)/resources/glyphs/normalized-glyphs-latin.txt \
       $(REDEMPTION_SYS_PATH)/etc/rdpproxy/ppocr.latin/glyphs.txt
    cp $(PPOCR_MODULE_PATH)/resources/datas/latin.txt \
       $(REDEMPTION_SYS_PATH)/etc/rdpproxy/ppocr.latin/datas.txt
    cp $(PPOCR_MODULE_PATH)/resources/dict_fr.trie \
       $(REDEMPTION_SYS_PATH)/etc/rdpproxy/ppocr.latin/dict.trie.txt
    cp $(PPOCR_MODULE_PATH)/resources/words_lines-latin.txt \
       $(REDEMPTION_SYS_PATH)/etc/rdpproxy/ppocr.latin/words_lines.txt

    # latin-cyrillic
    cp $(PPOCR_MODULE_PATH)/resources/glyphs/normalized-glyphs-latin-cyrillic.txt \
       $(REDEMPTION_SYS_PATH)/etc/rdpproxy/ppocr.latin-cyrillic/glyphs.txt
    cp $(PPOCR_MODULE_PATH)/resources/datas/latin-cyrillic.txt \
       $(REDEMPTION_SYS_PATH)/etc/rdpproxy/ppocr.latin-cyrillic/datas.txt
    cp $(PPOCR_MODULE_PATH)/resources/words_lines-latin-cyrillic.txt \
       $(REDEMPTION_SYS_PATH)/etc/rdpproxy/ppocr.latin-cyrillic/words_lines.txt
    cp $(PPOCR_MODULE_PATH)/resources/dict_fr.trie \
       $(REDEMPTION_SYS_PATH)/etc/rdpproxy/ppocr.latin-cyrillic/dict.trie.txt
}

explicit ppocr_resources ;

make ppocr_resources :
    ppocr_write_glyphs
    ppocr_normalize_glyphs
    ppocr_write_datas
:
    @make_ppocr_resources
;


## } ppocr resources


#
# Functional tests (run by hand)
#

exe tls_test_client
    :
        $(REDEMPTION_SRC_PATH)/ftests/tls_test_client.cpp openssl crypto png dl snappy
    :
#         <link>static
        $(EXE_DEPENDENCIES)
 ;
exe tls_test_server
    :
        $(REDEMPTION_SRC_PATH)/ftests/tls_test_server.cpp openssl crypto png dl snappy
    :
#         <link>static
        $(EXE_DEPENDENCIES)
;


#
# Unit Tests
#

# To compute coverage
# ===================
# bjam coverage test_utf.coverage

## Acl tests
## @{
test-canonical acl/acl_serializer.hpp : <library>bitmap <library>png.o <library>video_capture <library>crypto <library>snappy ;
test-canonical acl/auth_api.hpp ;
test-canonical acl/authentifier.hpp : <library>crypto <library>png <library>snappy ;
test-canonical acl/module_manager.hpp : <library>crypto <library>png <library>snappy ;
test-canonical acl/mm_api.hpp ;
## @}


## Ocr
## {
test-run test_ocr : capture/test_ocr.cpp : : <library>bitmap <library>ocr.o ;
test-run test_ppocr : capture/test_ocr.cpp : : <library>bitmap <library>ocr.o ;
test-run test_bogus_ocr : capture/test_bogus_ocr.cpp : : <library>bitmap <library>ocr.o ;
test-run test_bogus_ppocr : capture/test_bogus_ppocr.cpp : : <library>bitmap <library>ocr ;
test-canonical capture/ocr/locale/latin_to_cyrillic.hpp : <library>ocr.o ;
## }


## Capture tests
## @{
test-canonical capture/RDPChunkedDevice.hpp ;
test-canonical capture/capture.hpp : <library>bitmap <library>png.o <library>crypto <library>dl <library>z <library>snappy <library>ocr <library>video_capture ;
test-canonical capture/video_capture.hpp : <library>bitmap <library>png.o <library>dl <library>video_capture ;
test-canonical capture/wrm_capture.hpp : <library>bitmap <library>png.o <library>crypto <library>png <library>z <library>snappy <library>dl ;
test-canonical capture/transparentchunk.hpp ;
test-canonical capture/transparentplayer.hpp ;
test-canonical capture/transparentrecorder.hpp ;
test-canonical capture/utils/match_finder.hpp : ;
## @}


## Test facility functions or classes
## @{
test-canonical utils/sugar/algostring.hpp ;
test-canonical utils/sugar/array_view.hpp ;
test-canonical utils/sugar/bytes_t.hpp ;
test-canonical utils/sugar/buffer_t.hpp ;
test-canonical utils/sugar/cast.hpp ;
test-canonical utils/sugar/exchange.hpp ;
test-canonical utils/sugar/finally.hpp ;
test-canonical utils/sugar/iter.hpp ;
test-canonical utils/sugar/local_fd.hpp ;
test-canonical utils/sugar/make_unique.hpp ;
test-canonical utils/sugar/movable_noncopyable.hpp ;
test-canonical utils/sugar/noncopyable.hpp ;
test-canonical utils/sugar/numerics/safe_conversions.hpp ;
test-canonical utils/sugar/range.hpp ;
test-canonical utils/sugar/splitter.hpp ;
test-canonical utils/sugar/strutils.hpp ;
test-canonical utils/sugar/underlying_cast.hpp ;
test-canonical utils/sugar/update_lock.hpp ;
## @}


## Capabilities tests
## @{
test-canonical core/RDP/capabilities.hpp ;
test-canonical core/RDP/capabilities/activate.hpp ;
test-canonical core/RDP/capabilities/bitmapcachehostsupport.hpp ;
test-canonical core/RDP/capabilities/bitmapcodecs.hpp ;
test-canonical core/RDP/capabilities/bmpcache2.hpp ;
test-canonical core/RDP/capabilities/cap_bitmap.hpp ;
test-canonical core/RDP/capabilities/cap_bmpcache.hpp ;
test-canonical core/RDP/capabilities/cap_brushcache.hpp ;
test-canonical core/RDP/capabilities/cap_font.hpp ;
test-canonical core/RDP/capabilities/cap_glyphcache.hpp ;
test-canonical core/RDP/capabilities/cap_share.hpp ;
test-canonical core/RDP/capabilities/cap_sound.hpp ;
test-canonical core/RDP/capabilities/colcache.hpp ;
test-canonical core/RDP/capabilities/common.hpp ;
test-canonical core/RDP/capabilities/compdesk.hpp ;
test-canonical core/RDP/capabilities/control.hpp ;
test-canonical core/RDP/capabilities/drawgdiplus.hpp ;
test-canonical core/RDP/capabilities/drawninegridcache.hpp ;
test-canonical core/RDP/capabilities/frameacknowledge.hpp ;
test-canonical core/RDP/capabilities/general.hpp ;
test-canonical core/RDP/capabilities/input.hpp ;
test-canonical core/RDP/capabilities/largepointer.hpp ;
test-canonical core/RDP/capabilities/multifragmentupdate.hpp ;
test-canonical core/RDP/capabilities/offscreencache.hpp ;
test-canonical core/RDP/capabilities/order.hpp ;
test-canonical core/RDP/capabilities/pointer.hpp ;
test-canonical core/RDP/capabilities/rail.hpp ;
test-canonical core/RDP/capabilities/surfacecommands.hpp ;
test-canonical core/RDP/capabilities/virchan.hpp ;
test-canonical core/RDP/capabilities/window.hpp ;
## @}


## Transport tests
## @{
# TODO test-canonical transport/detail/meta_writer.hpp ;
test-canonical transport/out_crypto_transport.hpp : <library>openssl <library>crypto <library>snappy <library>dl <library>z ;
test-canonical transport/in_crypto_transport.hpp : <library>openssl <library>crypto <library>snappy <library>dl <library>z ;
test-canonical transport/gzip_compression_transport.hpp : <library>z ;
test-canonical transport/in_file_transport.hpp ;
test-canonical transport/in_meta_sequence_transport.hpp : <library>crypto <library>png <library>snappy <library>dl <library>z ;
test-canonical transport/out_file_transport.hpp ;
test-canonical transport/snappy_compression_transport.hpp : <library>snappy ;
test-canonical transport/socket_transport.hpp : <library>openssl <library>crypto <library>dl ;
test-canonical transport/test_transport.hpp ;
# TODO mote to transport/
test-canonical utils/compression_transport_builder.hpp : <library>z <library>snappy ;
test-canonical capture/cryptofile.hpp : <library>openssl <library>crypto <library>snappy <library>dl <library>z ;

test-canonical main/do_recorder.hpp :
    <library>program_options.o <library>openssl <library>crypto <library>snappy <library>dl <library>z
    <library>do_recorder_test <library>ocr <library>bitmap <library>png.o
    <library>capture_test <library>video_capture
;


## @}


## utils
## @{
test-canonical utils/array.hpp ;
test-canonical utils/asynchronous_task_manager.hpp ;
test-canonical utils/authorization_channels.hpp ;
test-canonical utils/bitfu.hpp ;
test-canonical utils/bitmap_shrink.hpp : <library>bitmap  <library>crypto <library>png ;
test-canonical utils/cfgloader.hpp ;
test-canonical utils/colors.hpp ;
test-canonical utils/confdescriptor.hpp ;
test-canonical utils/d3des.hpp ;
test-canonical utils/diffiehellman.hpp ;
test-canonical utils/difftimeval.hpp ;
test-canonical utils/drawable.hpp : <library>bitmap <library>crypto ;
test-canonical utils/ellipse.hpp ;
test-canonical utils/fdbuf.hpp ;
test-canonical utils/fileutils.hpp ;
test-canonical utils/genrandom.hpp ;
test-canonical utils/genfstat.hpp ;
test-canonical utils/get_printable_password.hpp ;
test-canonical utils/log.hpp ;
test-canonical utils/netutils.hpp ;
test-canonical utils/outbound_connection_monitor_rules.hpp ;
test-canonical utils/parse.hpp ;
test-canonical utils/parse_ip_conntrack.hpp ;
#test-canonical utils/parser.hpp ;
test-canonical utils/pattutils.hpp ;
test-canonical utils/png.hpp : <library>png ;
test-canonical utils/rdtsc.hpp ;
test-canonical utils/rect.hpp ;
test-canonical utils/redirection_info.hpp ;
test-canonical utils/region.hpp ;
# TODO test-canonical utils/server_certificate.hpp ;
test-canonical utils/stream.hpp ;
test-canonical utils/theme.hpp   ;
test-canonical utils/timeout.hpp ;
test-canonical utils/timeval_ops.hpp ;
test-canonical utils/translation.hpp ;
test-canonical utils/urandom_read.hpp ;
test-canonical utils/utf.hpp ;
test-canonical utils/virtual_channel_data_sender.hpp ;
test-canonical utils/winpr/pattern.hpp ;
## @}


## Widget tests
## @{
# TODO test-canonical mod/internal/widget2/columnlayout.hpp ;
test-canonical mod/internal/widget2/composite.hpp : <library>png.o <library>png <library>crypto ;
test-canonical mod/internal/widget2/edit.hpp : <library>crypto ;
test-canonical mod/internal/widget2/edit_valid.hpp : <library>crypto ;
test-canonical mod/internal/widget2/flat_button.hpp : <library>crypto ;
test-canonical mod/internal/widget2/flat_dialog.hpp : <library>bitmap <library>png.o <library>png <library>crypto ;
test-canonical mod/internal/widget2/flat_interactive_target.hpp : <library>crypto ;
test-canonical mod/internal/widget2/flat_login.hpp : <library>bitmap <library>crypto ;
test-canonical mod/internal/widget2/flat_selector2.hpp : <library>crypto ;
test-canonical mod/internal/widget2/flat_wab_close.hpp : <library>bitmap <library>crypto ;
test-canonical mod/internal/widget2/grid.hpp : <library>crypto ;
test-canonical mod/internal/widget2/group_box.hpp : <library>crypto ;
test-canonical mod/internal/widget2/image.hpp : <library>bitmap <library>crypto ;
test-canonical mod/internal/widget2/label.hpp : <library>crypto ;
test-canonical mod/internal/widget2/labelgrid.hpp : <library>crypto ;
# TODO test-canonical mod/internal/widget2/linelayout.hpp ;
test-canonical mod/internal/widget2/multiline.hpp : <library>crypto ;
test-canonical mod/internal/widget2/number_edit.hpp : <library>crypto ;
test-canonical mod/internal/widget2/password.hpp : <library>crypto ;
# TODO test-canonical mod/internal/widget2/radio_list.hpp ;
test-canonical mod/internal/widget2/screen.hpp : <library>crypto ;
test-canonical mod/internal/widget2/scroll.hpp : <library>crypto ;
# TODO test-canonical mod/internal/widget2/stacklayout.hpp ;
test-canonical mod/internal/widget2/tab.hpp ;
test-canonical mod/internal/widget2/tooltip.hpp : <library>crypto ;
test-canonical mod/internal/widget2/widget.hpp : <library>crypto ;
test-canonical mod/internal/widget2/widget2_rect.hpp : <library>crypto ;
test-canonical mod/internal/widget2/flat_vnc_authentification.hpp ;
test-canonical mod/internal/widget2/language_button.hpp ;
test-canonical mod/internal/widget2/layout.hpp ;
test-canonical mod/internal/widget2/notify_api.hpp ;
## @}


## Widget for workflow
## @{
test-canonical mod/internal/widget2/flat_wait.hpp : <library>png <library>crypto ;
test-canonical mod/internal/widget2/flat_form.hpp : <library>png <library>crypto ;
## @}


## Mod tests
## @{
test-canonical mod/internal/bouncer2_mod.hpp : <library>png ;
test-canonical mod/internal/copy_paste.hpp : <library>png <library>crypto ;
test-canonical mod/internal/flat_dialog_mod.hpp : <library>bitmap ;
test-canonical mod/internal/flat_login_mod.hpp : <library>bitmap ;
test-canonical mod/internal/flat_wab_close_mod.hpp : <library>bitmap ;
test-canonical mod/internal/interactive_target_mod.hpp : <library>bitmap <library>crypto ;
test-canonical mod/internal/internal_mod.hpp ;
test-canonical mod/internal/replay_mod.hpp : <library>png ;
test-canonical mod/internal/test_card_mod.hpp : <library>bitmap ;
test-canonical mod/internal/widget_test_mod.hpp : <library>bitmap ;
test-canonical mod/internal/flat_selector2_mod.hpp ;
test-canonical mod/internal/flat_wait_mod.hpp ;
test-canonical mod/internal/transparent_replay_mod.hpp ;
## @}


## Apps
## @{
test-canonical utils/apps/app_proxy.hpp ;
test-canonical utils/apps/recording_progress.hpp ;
## }


## Regex tests
## @{
test-canonical regex/regex.hpp ;
test-canonical regex/regex_automate.hpp ;
test-canonical regex/regex_consumer.hpp ;
test-canonical regex/regex_parser.hpp ;
test-canonical regex/regex_st_automate.hpp ;
test-canonical regex/regex_state.hpp ;
test-canonical regex/regex_states_value.hpp ;
test-canonical regex/regex_utils.hpp ;

# test-run benchmark_regex_parser : benchmark/parser.cpp ;
# test-run benchmark_regex_search : benchmark/search.cpp ;
## @}


## NLA TESTS
## @{
test-canonical core/RDP/nla/asn1/ber.hpp ;
test-canonical core/RDP/nla/credssp.hpp : <library>crypto ;
test-canonical core/RDP/nla/nla.hpp : <library>dl <library>krb5 <library>gssglue <library>z <library>crypto ;
test-canonical core/RDP/nla/sspi.hpp ;

#alias test_ntlm_suite : test_ntlm_message_negotiate test_ntlm_avpair test_ntlm_message_challenge test_ntlm_message_authenticate test_ntlm_context ;

test-canonical core/RDP/nla/kerberos/credentials.hpp : <library>krb5 ;
test-canonical core/RDP/nla/kerberos/kerberos.hpp : <library>krb5 <library>gssglue ;
test-canonical core/RDP/nla/ntlm/ntlm.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/nla/ntlm/ntlm_avpair.hpp ;
test-canonical core/RDP/nla/ntlm/ntlm_context.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/nla/ntlm/ntlm_message_authenticate.hpp : <library>crypto ;
test-canonical core/RDP/nla/ntlm/ntlm_message_challenge.hpp : <library>crypto ;
test-canonical core/RDP/nla/ntlm/ntlm_message_negotiate.hpp : <library>crypto ;
test-canonical core/RDP/nla/ntlm/ntlm_message.hpp ;
## @}


## RDP caches
## @{
test-canonical core/RDP/caches/bmpcache.hpp : <library>bitmap <library>crypto ;
test-canonical core/RDP/caches/bmpcachepersister.hpp : <library>bitmap <library>crypto ;
test-canonical core/RDP/caches/brushcache.hpp ;
test-canonical core/RDP/caches/glyphcache.hpp ;
test-canonical core/RDP/caches/pointercache.hpp ;
## @}


## RDP core
## @{
test-canonical core/RDP/GraphicUpdatePDU.hpp ;
test-canonical core/RDP/PersistentKeyListPDU.hpp ;
test-canonical core/RDP/RDPDrawable.hpp : <library>bitmap <library>png.o <library>crypto ;
test-canonical core/RDP/RDPSerializer.hpp ;
test-canonical core/RDP/RefreshRectPDU.hpp : <library>crypto ;
test-canonical core/RDP/SaveSessionInfoPDU.hpp ;
test-canonical core/RDP/ServerRedirection.hpp ;
test-canonical core/RDP/autoreconnect.hpp ;
test-canonical core/RDP/bitmapupdate.hpp : <library>bitmap <library>crypto ;
test-canonical core/RDP/clipboard.hpp ;
test-canonical core/WMF/MetaFileFormat.hpp ;
test-canonical core/RDP/fastpath.hpp : <library>crypto ;
test-canonical core/RDP/lic.hpp : <library>crypto ;
test-canonical core/RDP/logon.hpp ;
test-canonical core/RDP/mcs.hpp ;
test-canonical core/RDP/mppc.hpp ;
test-canonical core/RDP/mppc_40.hpp ;
test-canonical core/RDP/mppc_50.hpp ;
test-canonical core/RDP/mppc_60.hpp ;
test-canonical core/RDP/mppc_61.hpp ;
test-canonical core/RDP/mppc_unified_dec.hpp ;
test-canonical core/RDP/nego.hpp : <library>openssl <library>crypto <library>dl <library>krb5 <library>gssglue ;
test-canonical core/RDP/non_null_terminated_utf16_from_utf8.hpp ;
test-canonical core/RDP/out_per_bstream.hpp ;
test-run test_rdp_pointer : core/RDP/test_pointer.cpp ;
test-canonical core/RDP/protocol.hpp ;
test-canonical core/RDP/remote_programs.hpp ;
test-canonical core/RDP/sec.hpp : <library>crypto ;
test-canonical core/RDP/share.hpp ;
test-canonical core/RDP/slowpath.hpp ;
test-canonical core/RDP/x224.hpp ;
## @}

test-canonical utils/word_identification.hpp ;

## Gcc
## @{
test-canonical core/RDP/gcc.hpp : <library>dl <library>z <library>crypto ;

test-canonical core/RDP/gcc/userdata/cs_net.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/gcc/userdata/cs_multitransport.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/gcc/userdata/cs_cluster.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/gcc/userdata/cs_core.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/gcc/userdata/cs_mcs_msgchannel.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/gcc/userdata/cs_security.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/gcc/userdata/cs_monitor.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/gcc/userdata/cs_monitor_ex.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/gcc/userdata/sc_core.hpp : <library>dl <library>z <library>crypto ;

test-canonical core/RDP/gcc/userdata/sc_sec1.hpp : <library>dl <library>z <library>crypto ;
test-canonical core/RDP/gcc/userdata/sc_net.hpp : <library>dl <library>z <library>crypto ;
## @}


## RDP Orders
## @{
test-canonical core/RDP/orders/AlternateSecondaryWindowing.hpp ;
test-canonical core/RDP/orders/RDPOrdersCommon.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryDestBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryEllipseCB.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryEllipseSC.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryGlyphIndex.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryLineTo.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryMem3Blt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryMemBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryMultiDstBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryMultiOpaqueRect.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryMultiPatBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryMultiScrBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryOpaqueRect.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryPatBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryPolygonCB.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryPolygonSC.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryPolyline.hpp ;
test-canonical core/RDP/orders/RDPOrdersPrimaryScrBlt.hpp ;
test-canonical core/RDP/orders/RDPOrdersSecondaryBmpCache.hpp : <library>bitmap <library>crypto ;
test-canonical core/RDP/orders/RDPOrdersSecondaryBrushCache.hpp ;
test-canonical core/RDP/orders/RDPOrdersSecondaryColorCache.hpp ;
test-canonical core/RDP/orders/RDPOrdersSecondaryFrameMarker.hpp ;
test-canonical core/RDP/orders/RDPOrdersSecondaryGlyphCache.hpp ;
## @}


## RDP channels
## @{
test-canonical mod/rdp/channels/base_channel.hpp ;
test-canonical mod/rdp/channels/rdpdr_file_system_drive_manager.hpp ;
test-canonical mod/rdp/channels/rail_window_id_manager.hpp ;
test-canonical mod/rdp/channels/sespro_alternate_shell_based_launcher.hpp ;
test-canonical mod/rdp/channels/sespro_channel.hpp ;
test-canonical mod/rdp/channels/sespro_clipboard_based_launcher.hpp ;
test-canonical mod/rdp/channels/sespro_launcher.hpp ;
test-canonical mod/rdp/channels/rdpdr_asynchronous_task.hpp ;
test-canonical mod/rdp/channels/cliprdr_channel.hpp : <library>png ;
test-canonical mod/rdp/channels/rdpdr_channel.hpp : <library>png ;
## @}


## Mod tests
## @{
test-canonical mod/mod_api.hpp ;
test-canonical mod/null/null.hpp ;
test-canonical mod/rdp/rdp_log.hpp ;
test-canonical mod/rdp/rdp_orders.hpp ;
test-canonical mod/rdp/rdp_params.hpp ;
test-canonical mod/vnc/vnc.hpp : <library>bitmap <library>d3des.o ;
test-canonical mod/xup/xup.hpp ;
test-canonical mod/rdp/rdp.hpp : <library>bitmap <library>krb5 <library>gssglue <library>png <library>d3des.o <library>z <library>dl <library>crypto ;
## @}


## Bitmap
## @{
test-canonical utils/bitmap.hpp : <library>bitmap <library>crypto ;
test-canonical utils/bitmap_from_file.hpp : <library>bitmap ;
test-canonical utils/bitmap_data_allocator.hpp ;

test-run test_libpng : test_libpng.cpp : : <library>png <library>z <covflag>nocover ;
test-run test_bitmap_perf : test_bitmap_perf.cpp : : <library>bitmap <covflag>nocover ;
## @}


## utils/crypto
## @{
# test-canonical utils/crypto/ssl_mod_exp_direct : ;
test-canonical utils/crypto/ssl_aes_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_lib.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_md4_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_md5_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_rc4_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_sha1_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_sha256_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_sha512_direct.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical utils/crypto/ssl_sign.hpp : <library>openssl <library>crypto <library>dl <library>z ;
## @}


## system/linux
## @{
test-canonical system/linux/system/openssl.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_aes.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_calls.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_md4.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_md5.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_mod_exp.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_rc4.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_sha1.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_sha256.hpp : <library>openssl <library>crypto <library>dl <library>z ;
test-canonical system/linux/system/ssl_sha512.hpp : <library>openssl <library>crypto <library>dl <library>z ;
## @}


## client_mods
## @{
test-run test_rdp_client_test_card
    : client_mods/test_rdp_client_test_card.cpp
    :
    : <library>bitmap
      <library>z
      <library>crypto
      <library>dl
      <library>openssl
      <covflag>nocover
    ;

test-run test_rdp_client_large_pointer
    : client_mods/test_rdp_client_large_pointer.cpp
    :
    : <library>bitmap
      <library>png.o
      <library>krb5
      <library>gssglue
      <library>png
      <library>crypto
      <library>d3des.o
      <library>z
      <library>dl
      <library>openssl
      <covflag>nocover
    ;

test-run test_rdp_client_tls_w2008
    : client_mods/test_rdp_client_tls_w2008.cpp
    :
    : <library>bitmap
      <library>krb5
      <library>gssglue
      <library>png
      <library>crypto
      <library>d3des.o
      <library>z
      <library>dl
      <library>openssl
      <covflag>nocover
    ;

test-run test_rdp_client_wab
    : client_mods/test_rdp_client_wab.cpp
    :
    : <library>bitmap
      <library>png.o
      <library>krb5
      <library>gssglue
      <library>png
      <library>crypto
      <library>d3des.o
      <library>openssl
      <library>dl
      <library>krb5
      <library>gssglue
      <covflag>nocover
    ;

test-run test_vnc_client_simple
    : client_mods/test_vnc_client_simple.cpp
    :
    : <library>bitmap
      <library>krb5
      <library>gssglue
      <library>crypto
      <library>d3des.o
      <library>dl
      <library>z
      <covflag>nocover
    ;
## @}



test-run cli_vnc_connection
    : client_mods/cli_vnc_connection.cpp
    :
    : <library>bitmap
      <library>krb5
      <library>gssglue
      <library>png
      <library>openssl
      <library>crypto
      <library>d3des.o
      <library>dl
      <covflag>nocover
    ;
## @}


## server/
## @{
test-run test_rdesktop_client
  : server/test_rdesktop_client.cpp
  :
  : <library>bitmap
    <library>video_capture
    <library>capture_test
    <library>png.o
    <library>openssl
    <library>snappy
    <library>d3des.o
    <library>crypto
    <library>dl
    <library>ocr
    <covflag>nocover
;


test-run test_mstsc_client
  : server/test_mstsc_client.cpp
  :
  : <library>bitmap
    <library>video_capture
    <library>capture_test
    <library>png.o
    <library>openssl
    <library>snappy
    <library>d3des.o
    <library>crypto
    <library>dl
    <library>ocr
    <covflag>nocover
;


test-run test_mstsc_client_rdp50bulk
  : server/test_mstsc_client_rdp50bulk.cpp
  :
  : <library>bitmap
    <library>video_capture
    <library>capture_test
    <library>png.o
    <library>openssl
    <library>snappy
    <library>d3des.o
    <library>crypto
    <library>dl
    <library>ocr
    <covflag>nocover
;
## @}


## core/
## @{
test-canonical core/FSCC/FileInformation.hpp ;
test-canonical core/RDP/channels/rdpdr.hpp ;
test-canonical core/SMB2/MessageSyntax.hpp ;
test-canonical core/authid.hpp ;
test-canonical core/callback.hpp ;
test-canonical core/channel_list.hpp ;
test-canonical core/channel_names.hpp ;
test-canonical core/check_files.hpp ;
test-canonical core/client_info.hpp ;
test-canonical core/defines.hpp ;
test-canonical core/error.hpp ;
test-canonical core/font.hpp ;
test-canonical core/front_api.hpp ;
test-canonical core/listen.hpp ;
test-canonical core/mainloop.hpp ;
test-canonical core/server.hpp ;
test-canonical core/server_notifier_api.hpp ;
test-canonical core/session.hpp : <library>png <library>crypto <library>z <library>snappy <library>dl ;
test-canonical core/session_server.hpp :  <library>png <library>crypto <library>z <library>snappy <library>dl ;
test-canonical core/wait_obj.hpp ;
## @}


test-canonical front/front.hpp
  : <library>bitmap
    <library>video_capture
    <library>capture_test
    <library>png.o
    <library>openssl
    <library>snappy
    <library>d3des.o
    <library>krb5
    <library>gssglue
    <library>d3des.o
    <library>dl
    <library>crypto
    <library>ocr
;

test-canonical keyboard/keymap2.hpp ;
test-canonical keyboard/keymapSym.hpp ;

test-canonical gdi/graphic_cmd_color.hpp ;
test-canonical gdi/protected_graphics.hpp : <library>bitmap <library>png.o <library>crypto <library>z <library>snappy <library>dl ;


#explicit test_show_data.o bitmap.o_data_allocator.o test_data_draw ; #

#obj test_show_data.o : $(REDEMPTION_TEST_PATH)/mod/rdp/test_show_data.cpp
#    : <cxxflags>-fPIC ;

#exe test_show_data :
#    bitmap.o_data_allocator.o
#    test_show_data.o
#    krb5
#    openssl
#    crypto
#    gssglue
#    #png
#    d3des.o
#    z
#    dl
#    : <cxxflags>-fPIC
#    ;


test-run test_meta_protocol2 : test_meta_protocol2.cpp : : <cxxflags>-std=c++14 <library>crypto <library>openssl ;
explicit test_meta_protocol2 ;

explicit server_sc1 client_sc1 ;

exe server_sc1
    :
        $(REDEMPTION_TEST_PATH)/tcptest/Server_Sc1.cpp
    :
        $(EXE_DEPENDENCIES)
    ;

exe client_sc1
    :
        $(REDEMPTION_TEST_PATH)/tcptest/Client_Sc1.cpp
    :
        $(EXE_DEPENDENCIES)
    ;

exe proxy_sc1
    :
        $(REDEMPTION_TEST_PATH)/tcptest/Proxy_Sc1.cpp
    :
        $(EXE_DEPENDENCIES)
    ;



actions pass {
    touch $(<)
}

explicit install-sashimi local-install-sashimi sashimi ;

install install-sashimi
    : sashimi
    : <location>debian/sashimi/usr/lib
    ;

install local-install-sashimi
    : sashimi
    : <location>/usr/lib
    ;

obj sashimi_error : $(REDEMPTION_SRC_PATH)/sashimi/ssh_error.cpp ;
obj sashimi_pki : $(REDEMPTION_SRC_PATH)/sashimi/pki.cpp ;
obj sashimi_channels : $(REDEMPTION_SRC_PATH)/sashimi/channels.cpp ;
obj sashimi_sftp : $(REDEMPTION_SRC_PATH)/sashimi/sftp.cpp ;
obj sashimi_libssh : $(REDEMPTION_SRC_PATH)/sashimi/libssh.cpp ;

lib sashimi :
    sashimi_pki
    sashimi_channels
    sashimi_sftp
    sashimi_libssh
    sashimi_error
#    #openssl
    krb5
    gssapi_krb5
    crypto
    dl
    z
    rt
    :
    <link>shared
    :
    :
;

##
## Unit Tests
##

unit-test test_buffer :
    $(REDEMPTION_TEST_PATH)/sashimi/test_buffer.cpp
    sashimi_error
    libunit_test
    :
    $(TEST_DEPENDENCIES)
    ;

unit-test test_crypto :
    $(REDEMPTION_TEST_PATH)/sashimi/test_crypto.cpp
    sashimi_error
    crypto
    libunit_test
    :
    $(TEST_DEPENDENCIES)
    ;
