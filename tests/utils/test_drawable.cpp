/*
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software
   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

   Product name: redemption, a FLOSS RDP proxy
   Copyright (C) Wallix 2011-2013
   Author(s): Christophe Grosjean, Martin Potier

   Unit test of Drawing primitive used to create snapshot/movies
   Using lib boost functions for testing
*/

#include "test_only/test_framework/redemption_unit_tests.hpp"
#include "test_only/test_framework/check_img.hpp"

#include "utils/bitmap.hpp"
#include "utils/drawable.hpp"
#include "utils/drawable_pointer.hpp"
#include "utils/ellipse.hpp"
#include "utils/timestamp_tracer.hpp"
#include "core/RDP/rdp_pointer.hpp"

#define IMG_TEST_PATH FIXTURES_PATH "/img_ref/utils/drawable/"

RED_AUTO_TEST_CASE(TestLineTo)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    Drawable gd(width, height);
    gd.opaquerect(screen_rect, gd.u32bgr_to_color(WHITE));
    gd.opaquerect(screen_rect.shrink(5), gd.u32bgr_to_color(BLACK));

    uint16_t y = screen_rect.cy - 1;
    for (uint16_t x = 0 ; x < screen_rect.cx ; x += 40){
        gd.draw_line(0, 0, 0, x, y, 0xCC, gd.u32bgr_to_color(GREEN), screen_rect);
        gd.draw_line(0, x + 10, y , 0, 0, 0xCC, gd.u32bgr_to_color(RED), screen_rect);
        gd.draw_line(0, screen_rect.cx - 1, 0, screen_rect.cx - 1 - x, y, 0xCC, gd.u32bgr_to_color(WHITE), screen_rect);
        gd.draw_line(0, screen_rect.cx - 1 - x + 10, y, screen_rect.cx - 1, 0, 0xCC, gd.u32bgr_to_color(BLUE), screen_rect);
    }
    gd.draw_line(0, 0, 0, 640, 480, 0xCC, gd.u32bgr_to_color(GREEN), screen_rect);

    gd.draw_line(0, 0, 0, 1024, 0, 0xCC, gd.u32bgr_to_color(PINK), screen_rect);
    gd.draw_line(0, 0, 0, 0, 768, 0xCC, gd.u32bgr_to_color(PINK), screen_rect);
    gd.draw_line(0, 639, 0, 639, 768, 0xCC, gd.u32bgr_to_color(PINK), screen_rect);
    gd.draw_line(0, 0, 479, 1024, 479, 0xCC, gd.u32bgr_to_color(PINK), screen_rect);

    gd.draw_line(10, 0, 10, 1024, 479, 0xCC, gd.u32bgr_to_color(PINK), screen_rect.shrink(5));

    RED_CHECK_IMG(gd, IMG_TEST_PATH "line_to.png");
}

RED_AUTO_TEST_CASE(TestEllipse)
{
    uint16_t width = 1280;
    uint16_t height = 1024;
    Rect screen_rect(0, 0, width, height);
    Drawable gd(width, height);
    gd.opaquerect(screen_rect, gd.u32bgr_to_color(WHITE));
    gd.opaquerect(screen_rect.shrink(5), gd.u32bgr_to_color(LIGHT_GREEN));

//     uint64_t usec = ustime();
//     uint64_t cycles = rdtsc();

    gd.ellipse(Ellipse(Rect(2, 200, 540, 32)), 0x06, 0x01, gd.u32bgr_to_color(BLUE));

//     uint64_t elapusec = ustime() - usec;
//     uint64_t elapcyc = rdtsc() - cycles;
//     LOG(LOG_INFO, "elapsed time = %llu %llu %f\n", elapusec, elapcyc, (double)elapcyc / (double)elapusec);
//
//     usec = ustime();
//     cycles = rdtsc();

    gd.ellipse(Ellipse(Rect(100, 2, 40, 400)), 0x06, 0x01, gd.u32bgr_to_color(RED));

//     elapusec = ustime() - usec;
//     elapcyc = rdtsc() - cycles;
//     LOG(LOG_INFO, "elapsed time = %llu %llu %f\n", elapusec, elapcyc, (double)elapcyc / (double)elapusec);
//
//     usec = ustime();
//     cycles = rdtsc();

    gd.ellipse(Ellipse(Rect(2, 300, 540, 32)), 0x06, 0x00, gd.u32bgr_to_color(BLUE));
    gd.ellipse(Ellipse(Rect(200, 2, 40, 400)), 0x06, 0x00, gd.u32bgr_to_color(RED));

    gd.ellipse(Ellipse(Rect(2, 600, 540, 32)), 0x0D, 0x00, gd.u32bgr_to_color(BLUE));
    gd.ellipse(Ellipse(Rect(200, 500, 40, 401)), 0x0D, 0x00, gd.u32bgr_to_color(RED));

    gd.ellipse(Ellipse(Rect(2, 610, 540, 32)), 0x0D, 0x01, gd.u32bgr_to_color(BLUE));
    gd.ellipse(Ellipse(Rect(300, 500, 40, 401)), 0x0D, 0x01, gd.u32bgr_to_color(RED));



    gd.ellipse(Ellipse(Rect(700, 12, 6, 6)), 0x0D, 0x00, gd.u32bgr_to_color(BLUE));
    gd.ellipse(Ellipse(Rect(715, 12, 6, 6)), 0x0D, 0x01, gd.u32bgr_to_color(BLUE));
    gd.ellipse(Ellipse(Rect(730, 12, 6, 6)), 0x06, 0x00, gd.u32bgr_to_color(BLUE));
    gd.ellipse(Ellipse(Rect(745, 12, 6, 6)), 0x06, 0x01, gd.u32bgr_to_color(BLUE));

    gd.ellipse(Ellipse(Rect(700, 28, 5, 5)), 0x0D, 0x00, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(715, 28, 5, 5)), 0x0D, 0x01, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(730, 28, 5, 5)), 0x06, 0x00, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(745, 28, 5, 5)), 0x06, 0x01, gd.u32bgr_to_color(GREEN));

    gd.ellipse(Ellipse(Rect(800, 12, 8, 8)), 0x0D, 0x00, gd.u32bgr_to_color(BLUE));
    gd.ellipse(Ellipse(Rect(815, 12, 8, 8)), 0x0D, 0x01, gd.u32bgr_to_color(BLUE));
    gd.ellipse(Ellipse(Rect(830, 12, 8, 8)), 0x06, 0x00, gd.u32bgr_to_color(BLUE));
    gd.ellipse(Ellipse(Rect(845, 12, 8, 8)), 0x06, 0x01, gd.u32bgr_to_color(BLUE));

    gd.ellipse(Ellipse(Rect(800, 38, 15, 15)), 0x0D, 0x00, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(815, 38, 15, 15)), 0x0D, 0x01, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(830, 38, 15, 15)), 0x06, 0x00, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(845, 38, 15, 15)), 0x06, 0x01, gd.u32bgr_to_color(GREEN));

    gd.ellipse(Ellipse(Rect(800, 88, 5, 15)), 0x0D, 0x00, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(815, 88, 5, 15)), 0x0D, 0x01, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(830, 88, 5, 15)), 0x06, 0x00, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(845, 88, 5, 15)), 0x06, 0x01, gd.u32bgr_to_color(GREEN));

    gd.ellipse(Ellipse(Rect(700, 88, 10, 10)), 0x0D, 0x00, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(715, 88, 10, 10)), 0x0D, 0x01, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(730, 88, 10, 10)), 0x06, 0x00, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(745, 88, 10, 10)), 0x06, 0x01, gd.u32bgr_to_color(GREEN));

    gd.ellipse(Ellipse(Rect(700, 888, 40, 30)), 0x0D, 0x00, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(750, 888, 40, 30)), 0x0D, 0x01, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(800, 888, 40, 30)), 0x06, 0x00, gd.u32bgr_to_color(MEDIUM_BLUE));
    gd.ellipse(Ellipse(Rect(850, 888, 40, 30)), 0x06, 0x01, gd.u32bgr_to_color(BLUE));

    gd.ellipse(Ellipse(Rect(700, 930, 30, 40)), 0x0D, 0x00, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(750, 930, 30, 40)), 0x0D, 0x01, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(800, 930, 30, 40)), 0x06, 0x00, gd.u32bgr_to_color(MEDIUM_BLUE));
    gd.ellipse(Ellipse(Rect(850, 930, 30, 40)), 0x06, 0x01, gd.u32bgr_to_color(BLUE));

    gd.ellipse(Ellipse(Rect(700, 600, 230, 140)), 0x0D, 0x00, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(750, 530, 310, 240)), 0x07, 0x01, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(800, 700, 130, 140)), 0x0E, 0x00, gd.u32bgr_to_color(MEDIUM_BLUE));
    gd.ellipse(Ellipse(Rect(880, 700, 130, 40)), 0x06, 0x01, gd.u32bgr_to_color(BLUE));

    gd.ellipse(Ellipse(Rect(600, 300, 120, 120)), 0x0D, 0x00, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(650, 300, 130, 130)), 0x07, 0x01, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(700, 300, 140, 140)), 0x0E, 0x00, gd.u32bgr_to_color(MEDIUM_BLUE));
    gd.ellipse(Ellipse(Rect(750, 300, 130, 130)), 0x06, 0x01, gd.u32bgr_to_color(BLUE));

    gd.ellipse(Ellipse(Rect(900, 20, 120, 130)), 0x0D, 0x00, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(1000, 30, 120, 130)), 0x07, 0x01, gd.u32bgr_to_color(GREEN));
    gd.ellipse(Ellipse(Rect(910, 200, 120, 140)), 0x0E, 0x00, gd.u32bgr_to_color(MEDIUM_BLUE));
    gd.ellipse(Ellipse(Rect(1000, 180, 140, 120)), 0x06, 0x01, gd.u32bgr_to_color(BLUE));

    gd.ellipse(Ellipse(Rect(1000, 400, 130, 140)), 0x0D, 0x00, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(1100, 550, 140, 130)), 0x0D, 0x00, gd.u32bgr_to_color(BLUE));

    gd.ellipse(Ellipse(Rect(1030, 430, 65, 70)), 0x0D, 0x00, gd.u32bgr_to_color(RED));

    // binary raster operations

    gd.ellipse(Ellipse(Rect(300, 10, 30, 40)), 0x02, 0x01, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(300, 55, 30, 40)), 0x03, 0x01, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(300, 105, 30, 40)), 0x04, 0x01, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(300, 155, 30, 40)), 0x05, 0x01, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(350, 10, 30, 40)), 0x08, 0x01, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(350, 55, 30, 40)), 0x09, 0x01, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(350, 105, 30, 40)), 0x0A, 0x01, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(350, 155, 30, 40)), 0x0C, 0x01, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(400, 10, 30, 40)), 0x0F, 0x01, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(400, 55, 30, 40)), 0x01, 0x01, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(400, 105, 30, 40)), 0x10, 0x01, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(400, 105, 30, 40)), 0x10, 0x0B, gd.u32bgr_to_color(RED));
    gd.ellipse(Ellipse(Rect(400, 155, 30, 40)), 0x06, 0x01, gd.u32bgr_to_color(RED));

//     elapusec = ustime() - usec;
//     elapcyc = rdtsc() - cycles;
//
//     LOG(LOG_INFO, "elapsed time = %llu %llu %f\n", elapusec, elapcyc, (double)elapcyc / (double)elapusec);

    RED_CHECK_IMG(gd, IMG_TEST_PATH "ellipse.png");
}

RED_AUTO_TEST_CASE(TestPatBlt)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    Drawable gd(width, height);
    gd.patblt(screen_rect, 0xFF, gd.u32bgr_to_color(WHITE));
    gd.patblt(screen_rect.shrink(5), 0x00, gd.u32bgr_to_color(WHITE));


    gd.opaquerect(screen_rect.shrink(10), gd.u32bgr_to_color(RED));
    // RED inverted becomes CYAN
    gd.patblt(screen_rect.shrink(15), 0x55, gd.u32bgr_to_color(WHITE));

    gd.opaquerect(screen_rect.shrink(20), gd.u32bgr_to_color(RED));
    // Should be Black
    gd.patblt(screen_rect.shrink(25), 0x05, gd.u32bgr_to_color(0xFFFF00));

    gd.opaquerect(screen_rect.shrink(30), gd.u32bgr_to_color(RED));
    // Should be RED
    gd.patblt(screen_rect.shrink(35), 0x0F, gd.u32bgr_to_color(0xFFFF00));

    gd.opaquerect(screen_rect.shrink(40), gd.u32bgr_to_color(GREEN));
    // Should be BLUE
    gd.patblt(screen_rect.shrink(45), 0x50, gd.u32bgr_to_color(0xFFFF00));

    gd.opaquerect(screen_rect.shrink(50), gd.u32bgr_to_color(GREEN));
    // Should be purple
    gd.patblt(screen_rect.shrink(55), 0x5A, gd.u32bgr_to_color(WHITE));

    gd.opaquerect(screen_rect.shrink(60), gd.u32bgr_to_color(GREEN));
    // Should be purple
    gd.patblt(screen_rect.shrink(65), 0x5F, gd.u32bgr_to_color(0xFFFF00));

    gd.opaquerect(screen_rect.shrink(70), gd.u32bgr_to_color(0xFF00FF));
    // Should be blue
    gd.patblt(screen_rect.shrink(75), 0xA0, gd.u32bgr_to_color(0xFFFF00));

    gd.opaquerect(screen_rect.shrink(80), gd.u32bgr_to_color(GREEN));
    // Should be GREEN
    gd.patblt(screen_rect.shrink(85), 0xA5, gd.u32bgr_to_color(WHITE));

    gd.opaquerect(screen_rect.shrink(90), gd.u32bgr_to_color(RED));
    // Should be white
    gd.patblt(screen_rect.shrink(95), 0xAF, gd.u32bgr_to_color(RED));

    gd.opaquerect(screen_rect.shrink(100), gd.u32bgr_to_color(GREEN));
    // Should be 0x2F2F2F Dark Grey
    gd.patblt(screen_rect.shrink(105), 0xF0, gd.u32bgr_to_color(0x2F2F2F));

    gd.opaquerect(screen_rect.shrink(110), gd.u32bgr_to_color(0xFF00FF));
    // Should be yellow
    gd.patblt(screen_rect.shrink(115), 0xF5, gd.u32bgr_to_color(RED));

    gd.opaquerect(screen_rect.shrink(120), gd.u32bgr_to_color(RED));
    // Should be purple
    gd.patblt(screen_rect.shrink(125), 0xFA, gd.u32bgr_to_color(BLUE));

    RED_CHECK_IMG(gd, IMG_TEST_PATH "pat_blt.png");
}

RED_AUTO_TEST_CASE(TestDestBlt)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    Drawable gd(width, height);
    //gd.patblt(screen_rect, 0xFF, gd.u32bgr_to_color(WHITE));
    gd.destblt(screen_rect, 0xFF); // WHITENESS
    gd.destblt(screen_rect.shrink(5), 0x00); // BLACKNESS
    gd.opaquerect(screen_rect.shrink(10), gd.u32bgr_to_color(RED)); // RED
    // RED inverted becomes CYAN
    gd.destblt(screen_rect.shrink(15), 0x55);

    RED_CHECK_IMG(gd, IMG_TEST_PATH "dest_blt.png");
}

RED_AUTO_TEST_CASE(TestAddMouse)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    Drawable gd(width, height);
    uint8_t  save_mouse[3072];   // 32 lines * 32 columns * 3 bytes per pixel = 3072 octets
    DrawablePointer current_pointer(drawable_default_pointer());

    gd.opaquerect(screen_rect, gd.u32bgr_to_color(RED)); // RED

    struct Data
    {
        int cx, cy;
        char const* imgref;
    };

    RED_TEST_CONTEXT_DATA(Data const& data, "cx: " << data.cx << "  cy: " << data.cy, {
        Data{100, 100, IMG_TEST_PATH "add_mouse_100x100.png"},
        Data{638, 470, IMG_TEST_PATH "add_mouse_638x470.png"},
        Data{-8, -8, IMG_TEST_PATH "add_mouse_-8x-8.png"},
    })
    {
        gd.trace_mouse(current_pointer, data.cx, data.cy, save_mouse);
        RED_CHECK_IMG(gd, data.imgref);

        gd.clear_mouse(current_pointer, data.cx, data.cy, save_mouse);
        RED_CHECK_IMG(gd, IMG_TEST_PATH "add_mouse_clear.png");
    }
}

RED_AUTO_TEST_CASE(TestTimestampMouse)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    Drawable gd(width, height);
    TimestampTracer timestamp_tracer(gdi::get_mutable_image_view(gd));
    gd.opaquerect(screen_rect, gd.u32bgr_to_color(RED));

    time_t rawtime;
    time(&rawtime);
    struct tm now;

    now.tm_sec  =  51;
    now.tm_min  =  11;
    now.tm_hour =  13;
    now.tm_mday =   8;
    now.tm_mon  =   2;
    now.tm_year = 112;
    now.tm_wday =   4;
    now.tm_yday =  67;
    now.tm_isdst =  0;

    timestamp_tracer.trace(now);
    RED_CHECK_IMG(gd, IMG_TEST_PATH "timestamp_mouse_1.png");

    now.tm_sec  =  00;
    now.tm_min  =  12;
    now.tm_hour =  13;
    now.tm_mday =   8;
    now.tm_mon  =   2;
    now.tm_year = 113;
    now.tm_wday =   4;
    now.tm_yday =  67;
    now.tm_isdst =  0;

    timestamp_tracer.clear();
    timestamp_tracer.trace(now);
    RED_CHECK_IMG(gd, IMG_TEST_PATH "timestamp_mouse_2.png");

    timestamp_tracer.clear();
    RED_CHECK_IMG(gd, IMG_TEST_PATH "add_mouse_clear.png");
}

RED_AUTO_TEST_CASE(TestGraphicableScrBlt)
{
    struct Data
    {
        uint8_t rop;
        int cx, cy;
        char const* name;
        char const* imgref;
    };
    Drawable gd(640, 480);
    RED_TEST_CONTEXT_DATA(Data const& data, "name: " << data.name, {
        Data{0x00,   0,  20, "down00",      IMG_TEST_PATH "scr_blt_1.png"},
        Data{0x00,  20,   0, "right00",     IMG_TEST_PATH "scr_blt_2.png"},
        Data{0x00, -20,   0, "left00",      IMG_TEST_PATH "scr_blt_3.png"},
        Data{0x00,   0, -20, "up00",        IMG_TEST_PATH "scr_blt_4.png"},
        Data{0x00, -20, -20, "left_up00",   IMG_TEST_PATH "scr_blt_5.png"},
        Data{0x11,   0,  20, "down11",      IMG_TEST_PATH "scr_blt_6.png"},
        Data{0x11,  20,   0, "right11",     IMG_TEST_PATH "scr_blt_7.png"},
        Data{0x11, -20,   0, "left11",      IMG_TEST_PATH "scr_blt_8.png"},
        Data{0x11,   0, -20, "up11",        IMG_TEST_PATH "scr_blt_9.png"},
        Data{0x11, -20, -20, "left_up11",   IMG_TEST_PATH "scr_blt_10.png"}
    })
    {
        gd.opaquerect(Rect(0, 0, gd.width(), gd.height()), gd.u32bgr_to_color(BLACK));
        gd.opaquerect(Rect(90, 90, 120, 120), gd.u32bgr_to_color(RED));
        gd.opaquerect(Rect(100, 100, 100, 100), gd.u32bgr_to_color(BLUE));
        gd.opaquerect(Rect(120, 120, 60, 60).intersect(Rect(100, 100, 100, 100)), gd.u32bgr_to_color(PINK));
        gd.scrblt(90, 90, Rect(300, 300, 120, 120), 0xCC);
        gd.scrblt(90, 90, Rect(90 + data.cx, 90 + data.cy, 120, 120), data.rop);
        RED_CHECK_IMG(gd, data.imgref);
    }
}

RED_AUTO_TEST_CASE(TestMemblt)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);

    Drawable gd(width, height);
    gd.opaquerect(screen_rect, gd.u32bgr_to_color(0x2F2F2F));
    gd.opaquerect(Rect(100,100,20, 20), gd.u32bgr_to_color(BLUE));

    uint8_t comp64x64RED[] = { 0xc0, 0x30, 0x00, 0x00, 0xFF, 0xf0, 0xc0, 0x0f, };
    BGRPalette const & palette332 = BGRPalette::classic_332();
    Bitmap bmp(BitsPerPixel{24}, BitsPerPixel{24}, &palette332, 64, 64, comp64x64RED, sizeof(comp64x64RED), true );

    gd.mem_blt(Rect(5, 5, 20, 20), bmp, 0, 0);
    gd.mem_blt_invert(Rect(25, 25, 20, 20), bmp, 0, 0);
    gd.black_color(Rect(45, 45, 20, 20));
    gd.white_color(Rect(65, 65, 20, 20));

    RED_CHECK_IMG(gd, IMG_TEST_PATH "mem_blt_1.png");
}

RED_AUTO_TEST_CASE(TestMemblt2)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 320;
    uint16_t height = 200;
    Rect screen_rect(0, 0, width, height);

    Drawable gd(width, height);
    gd.opaquerect(screen_rect, gd.u32bgr_to_color(0x2F2F2F));

    uint8_t raw_palette[] = {
/* 0000 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00,  // ................
/* 0010 */ 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0xc0, 0xc0, 0xc0, 0x00,  // ................
/* 0020 */ 0xc0, 0xdc, 0xc0, 0x00, 0xc8, 0xd0, 0xd4, 0x00, 0x01, 0x1f, 0x3f, 0x00, 0x01, 0x1f, 0x5f, 0x00,  // ..........?..._.
/* 0030 */ 0x01, 0x1f, 0x7f, 0x00, 0x01, 0x1f, 0x9f, 0x00, 0x01, 0x1f, 0xbf, 0x00, 0x01, 0x1f, 0xdf, 0x00,  // ................
/* 0040 */ 0x01, 0x3f, 0x01, 0x00, 0x01, 0x3f, 0x1f, 0x00, 0x01, 0x3f, 0x3f, 0x00, 0x01, 0x3f, 0x5f, 0x00,  // .?...?...??..?_.
/* 0050 */ 0x01, 0x3f, 0x7f, 0x00, 0x01, 0x3f, 0x9f, 0x00, 0x01, 0x3f, 0xbf, 0x00, 0x01, 0x3f, 0xdf, 0x00,  // .?...?...?...?..
/* 0060 */ 0x01, 0x5f, 0x01, 0x00, 0x01, 0x5f, 0x1f, 0x00, 0x01, 0x5f, 0x3f, 0x00, 0x01, 0x5f, 0x5f, 0x00,  // ._..._..._?..__.
/* 0070 */ 0x01, 0x5f, 0x7f, 0x00, 0x01, 0x5f, 0x9f, 0x00, 0x01, 0x5f, 0xbf, 0x00, 0x01, 0x5f, 0xdf, 0x00,  // ._..._..._..._..
/* 0080 */ 0x01, 0x7f, 0x01, 0x00, 0x01, 0x7f, 0x1f, 0x00, 0x01, 0x7f, 0x3f, 0x00, 0x01, 0x7f, 0x5f, 0x00,  // ..........?..._.
/* 0090 */ 0x01, 0x7f, 0x7f, 0x00, 0x01, 0x7f, 0x9f, 0x00, 0x01, 0x7f, 0xbf, 0x00, 0x01, 0x7f, 0xdf, 0x00,  // ................
/* 00a0 */ 0x01, 0x9f, 0x01, 0x00, 0x01, 0x9f, 0x1f, 0x00, 0x01, 0x9f, 0x3f, 0x00, 0x01, 0x9f, 0x5f, 0x00,  // ..........?..._.
/* 00b0 */ 0x01, 0x9f, 0x7f, 0x00, 0x01, 0x9f, 0x9f, 0x00, 0x01, 0x9f, 0xbf, 0x00, 0x01, 0x9f, 0xdf, 0x00,  // ................
/* 00c0 */ 0x01, 0xbf, 0x01, 0x00, 0x01, 0xbf, 0x1f, 0x00, 0x01, 0xbf, 0x3f, 0x00, 0x01, 0xbf, 0x5f, 0x00,  // ..........?..._.
/* 00d0 */ 0x01, 0xbf, 0x7f, 0x00, 0x01, 0xbf, 0x9f, 0x00, 0x01, 0xbf, 0xbf, 0x00, 0x01, 0xbf, 0xdf, 0x00,  // ................
/* 00e0 */ 0x01, 0xdf, 0x01, 0x00, 0x01, 0xdf, 0x1f, 0x00, 0x01, 0xdf, 0x3f, 0x00, 0x01, 0xdf, 0x5f, 0x00,  // ..........?..._.
/* 00f0 */ 0x01, 0xdf, 0x7f, 0x00, 0x01, 0xdf, 0x9f, 0x00, 0x01, 0xdf, 0xbf, 0x00, 0x01, 0xdf, 0xdf, 0x00,  // ................
/* 0100 */ 0x3f, 0x01, 0x01, 0x00, 0x3f, 0x01, 0x1f, 0x00, 0x3f, 0x01, 0x3f, 0x00, 0x3f, 0x01, 0x5f, 0x00,  // ?...?...?.?.?._.
/* 0110 */ 0x3f, 0x01, 0x7f, 0x00, 0x3f, 0x01, 0x9f, 0x00, 0x3f, 0x01, 0xbf, 0x00, 0x3f, 0x01, 0xdf, 0x00,  // ?...?...?...?...
/* 0120 */ 0x3f, 0x1f, 0x01, 0x00, 0x3f, 0x1f, 0x1f, 0x00, 0x3f, 0x1f, 0x3f, 0x00, 0x3f, 0x1f, 0x5f, 0x00,  // ?...?...?.?.?._.
/* 0130 */ 0x3f, 0x1f, 0x7f, 0x00, 0x3f, 0x1f, 0x9f, 0x00, 0x3f, 0x1f, 0xbf, 0x00, 0x3f, 0x1f, 0xdf, 0x00,  // ?...?...?...?...
/* 0140 */ 0x3f, 0x3f, 0x01, 0x00, 0x3f, 0x3f, 0x1f, 0x00, 0x3f, 0x3f, 0x3f, 0x00, 0x3f, 0x3f, 0x5f, 0x00,  // ??..??..???.??_.
/* 0150 */ 0x3f, 0x3f, 0x7f, 0x00, 0x3f, 0x3f, 0x9f, 0x00, 0x3f, 0x3f, 0xbf, 0x00, 0x3f, 0x3f, 0xdf, 0x00,  // ??..??..??..??..
/* 0160 */ 0x3f, 0x5f, 0x01, 0x00, 0x3f, 0x5f, 0x1f, 0x00, 0x3f, 0x5f, 0x3f, 0x00, 0x3f, 0x5f, 0x5f, 0x00,  // ?_..?_..?_?.?__.
/* 0170 */ 0x3f, 0x5f, 0x7f, 0x00, 0x3f, 0x5f, 0x9f, 0x00, 0x3f, 0x5f, 0xbf, 0x00, 0x3f, 0x5f, 0xdf, 0x00,  // ?_..?_..?_..?_..
/* 0180 */ 0x3f, 0x7f, 0x01, 0x00, 0x3f, 0x7f, 0x1f, 0x00, 0x3f, 0x7f, 0x3f, 0x00, 0x3f, 0x7f, 0x5f, 0x00,  // ?...?...?.?.?._.
/* 0190 */ 0x3f, 0x7f, 0x7f, 0x00, 0x3f, 0x7f, 0x9f, 0x00, 0x3f, 0x7f, 0xbf, 0x00, 0x3f, 0x7f, 0xdf, 0x00,  // ?...?...?...?...
/* 01a0 */ 0x3f, 0x9f, 0x01, 0x00, 0x3f, 0x9f, 0x1f, 0x00, 0x3f, 0x9f, 0x3f, 0x00, 0x3f, 0x9f, 0x5f, 0x00,  // ?...?...?.?.?._.
/* 01b0 */ 0x3f, 0x9f, 0x7f, 0x00, 0x3f, 0x9f, 0x9f, 0x00, 0x3f, 0x9f, 0xbf, 0x00, 0x3f, 0x9f, 0xdf, 0x00,  // ?...?...?...?...
/* 01c0 */ 0x3f, 0xbf, 0x01, 0x00, 0x3f, 0xbf, 0x1f, 0x00, 0x3f, 0xbf, 0x3f, 0x00, 0x3f, 0xbf, 0x5f, 0x00,  // ?...?...?.?.?._.
/* 01d0 */ 0x3f, 0xbf, 0x7f, 0x00, 0x3f, 0xbf, 0x9f, 0x00, 0x3f, 0xbf, 0xbf, 0x00, 0x3f, 0xbf, 0xdf, 0x00,  // ?...?...?...?...
/* 01e0 */ 0x3f, 0xdf, 0x01, 0x00, 0x3f, 0xdf, 0x1f, 0x00, 0x3f, 0xdf, 0x3f, 0x00, 0x3f, 0xdf, 0x5f, 0x00,  // ?...?...?.?.?._.
/* 01f0 */ 0x3f, 0xdf, 0x7f, 0x00, 0x3f, 0xdf, 0x9f, 0x00, 0x3f, 0xdf, 0xbf, 0x00, 0x3f, 0xdf, 0xdf, 0x00,  // ?...?...?...?...
/* 0200 */ 0x7f, 0x01, 0x01, 0x00, 0x7f, 0x01, 0x1f, 0x00, 0x7f, 0x01, 0x3f, 0x00, 0x7f, 0x01, 0x5f, 0x00,  // ..........?..._.
/* 0210 */ 0x7f, 0x01, 0x7f, 0x00, 0x7f, 0x01, 0x9f, 0x00, 0x7f, 0x01, 0xbf, 0x00, 0x7f, 0x01, 0xdf, 0x00,  // ................
/* 0220 */ 0x7f, 0x1f, 0x01, 0x00, 0x7f, 0x1f, 0x1f, 0x00, 0x7f, 0x1f, 0x3f, 0x00, 0x7f, 0x1f, 0x5f, 0x00,  // ..........?..._.
/* 0230 */ 0x7f, 0x1f, 0x7f, 0x00, 0x7f, 0x1f, 0x9f, 0x00, 0x7f, 0x1f, 0xbf, 0x00, 0x7f, 0x1f, 0xdf, 0x00,  // ................
/* 0240 */ 0x7f, 0x3f, 0x01, 0x00, 0x7f, 0x3f, 0x1f, 0x00, 0x7f, 0x3f, 0x3f, 0x00, 0x7f, 0x3f, 0x5f, 0x00,  // .?...?...??..?_.
/* 0250 */ 0x7f, 0x3f, 0x7f, 0x00, 0x7f, 0x3f, 0x9f, 0x00, 0x7f, 0x3f, 0xbf, 0x00, 0x7f, 0x3f, 0xdf, 0x00,  // .?...?...?...?..
/* 0260 */ 0x7f, 0x5f, 0x01, 0x00, 0x7f, 0x5f, 0x1f, 0x00, 0x7f, 0x5f, 0x3f, 0x00, 0x7f, 0x5f, 0x5f, 0x00,  // ._..._..._?..__.
/* 0270 */ 0x7f, 0x5f, 0x7f, 0x00, 0x7f, 0x5f, 0x9f, 0x00, 0x7f, 0x5f, 0xbf, 0x00, 0x7f, 0x5f, 0xdf, 0x00,  // ._..._..._..._..
/* 0280 */ 0x7f, 0x7f, 0x01, 0x00, 0x7f, 0x7f, 0x1f, 0x00, 0x7f, 0x7f, 0x3f, 0x00, 0x7f, 0x7f, 0x5f, 0x00,  // ..........?..._.
/* 0290 */ 0x7f, 0x7f, 0x7f, 0x00, 0x7f, 0x7f, 0x9f, 0x00, 0x7f, 0x7f, 0xbf, 0x00, 0x7f, 0x7f, 0xdf, 0x00,  // ................
/* 02a0 */ 0x7f, 0x9f, 0x01, 0x00, 0x7f, 0x9f, 0x1f, 0x00, 0x7f, 0x9f, 0x3f, 0x00, 0x7f, 0x9f, 0x5f, 0x00,  // ..........?..._.
/* 02b0 */ 0x7f, 0x9f, 0x7f, 0x00, 0x7f, 0x9f, 0x9f, 0x00, 0x7f, 0x9f, 0xbf, 0x00, 0x7f, 0x9f, 0xdf, 0x00,  // ................
/* 02c0 */ 0x7f, 0xbf, 0x01, 0x00, 0x7f, 0xbf, 0x1f, 0x00, 0x7f, 0xbf, 0x3f, 0x00, 0x7f, 0xbf, 0x5f, 0x00,  // ..........?..._.
/* 02d0 */ 0x7f, 0xbf, 0x7f, 0x00, 0x7f, 0xbf, 0x9f, 0x00, 0x7f, 0xbf, 0xbf, 0x00, 0x7f, 0xbf, 0xdf, 0x00,  // ................
/* 02e0 */ 0x7f, 0xdf, 0x01, 0x00, 0x7f, 0xdf, 0x1f, 0x00, 0x7f, 0xdf, 0x3f, 0x00, 0x7f, 0xdf, 0x5f, 0x00,  // ..........?..._.
/* 02f0 */ 0x7f, 0xdf, 0x7f, 0x00, 0x7f, 0xdf, 0x9f, 0x00, 0x7f, 0xdf, 0xbf, 0x00, 0x7f, 0xdf, 0xdf, 0x00,  // ................
/* 0300 */ 0xbf, 0x01, 0x01, 0x00, 0xbf, 0x01, 0x1f, 0x00, 0xbf, 0x01, 0x3f, 0x00, 0xbf, 0x01, 0x5f, 0x00,  // ..........?..._.
/* 0310 */ 0xbf, 0x01, 0x7f, 0x00, 0xbf, 0x01, 0x9f, 0x00, 0xbf, 0x01, 0xbf, 0x00, 0xbf, 0x01, 0xdf, 0x00,  // ................
/* 0320 */ 0xbf, 0x1f, 0x01, 0x00, 0xbf, 0x1f, 0x1f, 0x00, 0xbf, 0x1f, 0x3f, 0x00, 0xbf, 0x1f, 0x5f, 0x00,  // ..........?..._.
/* 0330 */ 0xbf, 0x1f, 0x7f, 0x00, 0xbf, 0x1f, 0x9f, 0x00, 0xbf, 0x1f, 0xbf, 0x00, 0xbf, 0x1f, 0xdf, 0x00,  // ................
/* 0340 */ 0xbf, 0x3f, 0x01, 0x00, 0xbf, 0x3f, 0x1f, 0x00, 0xbf, 0x3f, 0x3f, 0x00, 0xbf, 0x3f, 0x5f, 0x00,  // .?...?...??..?_.
/* 0350 */ 0xbf, 0x3f, 0x7f, 0x00, 0xbf, 0x3f, 0x9f, 0x00, 0xbf, 0x3f, 0xbf, 0x00, 0xbf, 0x3f, 0xdf, 0x00,  // .?...?...?...?..
/* 0360 */ 0xbf, 0x5f, 0x01, 0x00, 0xbf, 0x5f, 0x1f, 0x00, 0xbf, 0x5f, 0x3f, 0x00, 0xbf, 0x5f, 0x5f, 0x00,  // ._..._..._?..__.
/* 0370 */ 0xbf, 0x5f, 0x7f, 0x00, 0xbf, 0x5f, 0x9f, 0x00, 0xbf, 0x5f, 0xbf, 0x00, 0xbf, 0x5f, 0xdf, 0x00,  // ._..._..._..._..
/* 0380 */ 0xbf, 0x7f, 0x01, 0x00, 0xbf, 0x7f, 0x1f, 0x00, 0xbf, 0x7f, 0x3f, 0x00, 0xbf, 0x7f, 0x5f, 0x00,  // ..........?..._.
/* 0390 */ 0xbf, 0x7f, 0x7f, 0x00, 0xbf, 0x7f, 0x9f, 0x00, 0xbf, 0x7f, 0xbf, 0x00, 0xbf, 0x7f, 0xdf, 0x00,  // ................
/* 03a0 */ 0xbf, 0x9f, 0x01, 0x00, 0xbf, 0x9f, 0x1f, 0x00, 0xbf, 0x9f, 0x3f, 0x00, 0xbf, 0x9f, 0x5f, 0x00,  // ..........?..._.
/* 03b0 */ 0xbf, 0x9f, 0x7f, 0x00, 0xbf, 0x9f, 0x9f, 0x00, 0xbf, 0x9f, 0xbf, 0x00, 0xbf, 0x9f, 0xdf, 0x00,  // ................
/* 03c0 */ 0xbf, 0xbf, 0x01, 0x00, 0xbf, 0xbf, 0x1f, 0x00, 0xbf, 0xbf, 0x3f, 0x00, 0xbf, 0xbf, 0x5f, 0x00,  // ..........?..._.
/* 03d0 */ 0xbf, 0xbf, 0x7f, 0x00, 0xbf, 0xbf, 0x9f, 0x00, 0xf0, 0xfb, 0xff, 0x00, 0xa5, 0x6e, 0x3a, 0x00,  // .............n:.
/* 03e0 */ 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00,  // ................
/* 03f0 */ 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00,  // ................
    };
    uint8_t raw_bitmap[] = {
/* 0000 */ 0xc0, 0x30, 0x09, 0x00, 0x63, 0x30, 0x09, 0xd0, 0x14, 0xf5, 0x07, 0x00, 0x00, 0xcf, 0x09, 0x03,  // .0..c0..........
/* 0010 */ 0x84, 0x06, 0x06, 0x06, 0xfc, 0xc7, 0xf8, 0x82, 0xfc, 0x06, 0xd0, 0x0a, 0xfc, 0x03, 0x00, 0x87,  // ................
/* 0020 */ 0xfc, 0xfc, 0x09, 0x09, 0xfc, 0x00, 0x00, 0xd0, 0x13, 0x09, 0x0f, 0x00, 0x00, 0xc7, 0x01, 0x07,  // ................
/* 0030 */ 0x82, 0xfe, 0xfc, 0x69, 0x07, 0x81, 0xfc, 0xd0, 0x09, 0xfb, 0x01, 0x00, 0x8c, 0x03, 0xfc, 0x09,  // ...i............
/* 0040 */ 0x09, 0x00, 0x00, 0x04, 0x04, 0xfc, 0xfc, 0xfc, 0xfc, 0xd0, 0x0d, 0x0d, 0x03, 0x00, 0x8a, 0x01,  // ................
/* 0050 */ 0x01, 0xf9, 0xf9, 0xf9, 0xf9, 0xf9, 0xf9, 0x01, 0x01, 0x06, 0x8d, 0xfc, 0x07, 0x07, 0x00, 0x00,  // ................
/* 0060 */ 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x07, 0xfc, 0xd0, 0x0b, 0xfa, 0x01, 0x00, 0x83, 0x00, 0x04,  // ................
/* 0070 */ 0x04, 0x68, 0xfc, 0xd0, 0x0a, 0x0d, 0x01, 0x00, 0x83, 0x01, 0x01, 0xf9, 0x05, 0x84, 0x03, 0xf9,  // .h..............
/* 0080 */ 0xf9, 0xf9, 0x05, 0x84, 0x07, 0xff, 0x07, 0xf8, 0xd1, 0x07, 0x0f, 0x81, 0x07, 0xd0, 0x0a, 0xfa,  // ................
/* 0090 */ 0x01, 0x00, 0x8d, 0xfc, 0x04, 0x04, 0xfc, 0xfc, 0xfc, 0xf8, 0xf8, 0x00, 0xfc, 0xfc, 0xfc, 0xfc,  // ................
/* 00a0 */ 0xd0, 0x08, 0x0d, 0x01, 0x00, 0x92, 0x01, 0x01, 0xf9, 0xf9, 0xf9, 0x03, 0x03, 0x01, 0x03, 0x03,  // ................
/* 00b0 */ 0x03, 0x03, 0x03, 0x03, 0x09, 0x09, 0x09, 0xf8, 0xd0, 0x0c, 0xf8, 0x77, 0x00, 0xd0, 0x09, 0x04,  // ...........w....
/* 00c0 */ 0x01, 0x00, 0x8a, 0x03, 0xfc, 0x04, 0xfc, 0xfc, 0xfc, 0x09, 0x09, 0x09, 0x09, 0xd0, 0x0d, 0xfc,  // ................
/* 00d0 */ 0x01, 0x00, 0x8a, 0xf9, 0xf9, 0xf9, 0xf9, 0x03, 0x01, 0x04, 0x04, 0x04, 0x03, 0xd0, 0x1d, 0xf8,  // ................
/* 00e0 */ 0x01, 0x03, 0x00, 0x00, 0xd0, 0x09, 0x04, 0x01, 0x00, 0x6c, 0x09, 0x01, 0x81, 0x03, 0x05, 0x86,  // .........l......
/* 00f0 */ 0x03, 0x03, 0xf8, 0x04, 0x03, 0xfb, 0xd0, 0x0a, 0xf8, 0x81, 0x01, 0xd0, 0x11, 0xff, 0x01, 0x00,  // ................
/* 0100 */ 0x00, 0x86, 0xfb, 0x03, 0xfc, 0xfc, 0xfc, 0xfc, 0xc9, 0x0d, 0x0c, 0x86, 0x03, 0x06, 0x06, 0xf8,  // ................
/* 0110 */ 0x06, 0x04, 0xd0, 0x08, 0x07, 0x01, 0x00, 0x86, 0xff, 0x07, 0xf8, 0xff, 0x03, 0x03, 0x40, 0x0e,  // ..............@.
/* 0120 */ 0x01, 0x00, 0x81, 0x09, 0xd0, 0x19, 0xf8, 0xc3, 0x3f, 0x00, 0x00, 0x8f, 0x03, 0x03, 0x06, 0x06,  // ........?.......
/* 0130 */ 0x06, 0x06, 0x06, 0x04, 0x07, 0x07, 0x03, 0x09, 0x09, 0x09, 0x06, 0x40, 0x06, 0x45, 0x86, 0x03,  // ...........@.E..
/* 0140 */ 0x00, 0xf8, 0x07, 0x07, 0x07, 0xd0, 0x09, 0xfc, 0x01, 0x00, 0x8a, 0x04, 0x03, 0xfb, 0xfc, 0xfc,  // ................
/* 0150 */ 0xfc, 0x09, 0x09, 0x09, 0x09, 0x40, 0x0e, 0x01, 0x00, 0x9d, 0x03, 0x03, 0x03, 0xf8, 0x06, 0x06,  // .....@..........
/* 0160 */ 0x06, 0x06, 0x06, 0x06, 0x07, 0xfb, 0x09, 0x09, 0x09, 0x06, 0xfc, 0x07, 0xff, 0xf8, 0xf8, 0xf8,  // ................
/* 0170 */ 0x03, 0xfb, 0x03, 0x00, 0xf8, 0x07, 0x04, 0xd0, 0x09, 0xf8, 0x01, 0x00, 0x8e, 0x09, 0x04, 0x03,  // ................
/* 0180 */ 0xfb, 0xfc, 0xfc, 0xfc, 0x09, 0x09, 0x00, 0xfc, 0xfc, 0xfc, 0x04, 0x68, 0x09, 0xd0, 0x12, 0xfe,  // ...........h....
/* 0190 */ 0x80, 0x00, 0x00, 0x8b, 0x06, 0xfc, 0x07, 0xff, 0xff, 0x07, 0xff, 0x03, 0xfb, 0x03, 0x00, 0xd0,  // ................
/* 01a0 */ 0x0d, 0x03, 0x03, 0x00, 0x87, 0x04, 0x03, 0xfb, 0xfc, 0xfc, 0x04, 0x04, 0xd0, 0x12, 0xfc, 0x01,  // ................
/* 01b0 */ 0x00, 0x00, 0x66, 0x06, 0xfd, 0x06, 0x8c, 0xfe, 0x06, 0xfc, 0x07, 0xff, 0xff, 0xff, 0xff, 0x03,  // ..f.............
/* 01c0 */ 0xfb, 0x03, 0x00, 0xd0, 0x0b, 0xfb, 0x01, 0x00, 0x8c, 0x09, 0x04, 0xfc, 0xfc, 0xfb, 0xfc, 0xfc,  // ................
/* 01d0 */ 0xfc, 0xfc, 0xfc, 0xfc, 0x04, 0x69, 0x09, 0x01, 0x9f, 0xf9, 0x03, 0xf8, 0xf8, 0xf8, 0xf8, 0x06,  // .....i..........
/* 01e0 */ 0xfe, 0xfe, 0x06, 0x06, 0x07, 0x06, 0x00, 0x09, 0x09, 0x09, 0x06, 0x06, 0x06, 0x06, 0x06, 0xf8,  // ................
/* 01f0 */ 0xf8, 0xf8, 0xf8, 0xf8, 0x03, 0xfb, 0x03, 0x00, 0xd0, 0x0b, 0x04, 0x01, 0x00, 0x82, 0x09, 0x04,  // ................
/* 0200 */ 0x67, 0xfc, 0x83, 0x04, 0x09, 0x09, 0xd0, 0x08, 0xf5, 0x01, 0x00, 0x8e, 0x00, 0x03, 0xf8, 0xf8,  // g...............
/* 0210 */ 0x06, 0x06, 0x07, 0x07, 0xfe, 0x06, 0x07, 0x06, 0x00, 0x00, 0x6e, 0x09, 0x83, 0x03, 0xf9, 0x01,  // ..........n.....
/* 0220 */ 0x6f, 0x09, 0xd0, 0x12, 0x0d, 0x40, 0x00, 0x00, 0x82, 0x00, 0x00, 0x67, 0x07, 0x81, 0x06, 0xd0,  // o....@.....g....
/* 0230 */ 0x10, 0x06, 0x01, 0x00, 0x00, 0x81, 0x09, 0xd0, 0x10, 0xf8, 0x01, 0x00, 0x00, 0xc5, 0xf5, 0x42,  // ...............B
/* 0240 */ 0x1e, 0x00, 0x6b, 0x00, 0x0f, 0x60, 0x91, 0x09,                          // ..k..`..
    };

    const BGRPalette palette = make_bgr_palette_from_bgrx_array(raw_palette);

    Bitmap bmp(BitsPerPixel{8}, BitsPerPixel{8}, &palette, 64, 22, raw_bitmap, sizeof(raw_bitmap), true);

    // red square
    gd.mem_blt(Rect(5, 5, 20, 20), bmp, 0, 0);
    RED_CHECK_IMG(gd, IMG_TEST_PATH "mem_blt_2.png");
}

RED_AUTO_TEST_CASE(TestMemblt3)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 320;
    uint16_t height = 200;
    Rect screen_rect(0, 0, width, height);

    Drawable gd(width, height);
    gd.opaquerect(screen_rect, gd.u32bgr_to_color(0x2F2F2F));

    uint8_t raw_palette[] = {
/* 0000 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0010 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0020 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0030 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0040 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0050 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0060 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0070 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0080 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0090 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00a0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00b0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00c0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00d0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00e0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00f0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0100 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0110 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0120 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0130 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0140 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0150 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0160 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0170 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0180 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0190 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01a0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01b0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01c0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01d0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01e0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01f0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0200 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0210 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0220 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0230 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0240 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0250 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0260 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0270 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0280 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0290 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02a0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02b0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02c0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02d0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02e0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02f0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0300 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0310 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0320 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0330 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0340 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0350 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0360 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0370 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0380 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0390 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03a0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03b0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03c0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03d0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03e0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03f0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
    };
    uint8_t raw_bitmap[] = {
/* 0000 */ 0xc0, 0x0c, 0xb4, 0x1d, 0x84, 0xb4, 0x1d, 0xb4, 0x1d, 0xb4, 0x1d, 0xb4, 0x1d, 0xf0, 0x60, 0x01,  // ..............`.
/* 0010 */ 0xc0, 0x04, 0xed, 0x76, 0x00, 0x2e, 0xce, 0x70, 0x4e, 0x11, 0x8f, 0x08, 0x21, 0x52, 0x4a, 0x11,  // ...v...pN...!RJ.
/* 0020 */ 0x42, 0x10, 0x42, 0x10, 0x42, 0x10, 0x42, 0xf0, 0x3d, 0xf0, 0x3d, 0xef, 0x3d, 0xef, 0x3d, 0xef,  // B.B.B.B.=.=.=.=.
/* 0030 */ 0x3d, 0xef, 0x3d, 0xcf, 0x3d, 0x10, 0x42, 0x10, 0x42, 0x40, 0x31, 0x01, 0x00, 0x00, 0x00, 0x00,  // =.=.=.B.B@1.....
/* 0040 */ 0x00, 0x00, 0x8e, 0x32, 0x46, 0xef, 0x3d, 0xef, 0x3d, 0xef, 0x3d, 0xef, 0x3d, 0xef, 0x3d, 0xce,  // ...2F.=.=.=.=.=.
/* 0050 */ 0x39, 0xce, 0x39, 0xce, 0x39, 0xae, 0x39, 0xae, 0x39, 0xae, 0x39, 0xcf, 0x39, 0xcf, 0x39, 0x11,  // 9.9.9.9.9.9.9.9.
/* 0060 */ 0x83, 0x29, 0x25, 0x52, 0x4a, 0xf0, 0x3d, 0x06, 0x84, 0xcf, 0x39, 0xad, 0x35, 0xae, 0x35, 0xce,  // .)%RJ.=...9.5.5.
/* 0070 */ 0x39, 0x15, 0x8d, 0x7b, 0x6f, 0x39, 0x67, 0x11, 0x42, 0x11, 0x42, 0xcf, 0x3d, 0x9c, 0x73, 0x5a,  // 9..{o9g.B.B.=.sZ
/* 0080 */ 0x6b, 0xcf, 0x39, 0x9c, 0x73, 0x5a, 0x6b, 0xae, 0x35, 0x9c, 0x73, 0x9c, 0x73, 0x12, 0x8e, 0x94,  // k.9.sZk.5.s.s...
/* 0090 */ 0x52, 0xde, 0x7b, 0xff, 0x7f, 0xd6, 0x5a, 0xd6, 0x5a, 0xef, 0x3d, 0xff, 0x7f, 0x39, 0x67, 0xef,  // R.{...Z.Z.=..9g.
/* 00a0 */ 0x3d, 0xff, 0x7f, 0xf7, 0x5e, 0xce, 0x39, 0xff, 0x7f, 0xff, 0x7f, 0x12, 0x8e, 0x39, 0x67, 0xff,  // =...^.9......9g.
/* 00b0 */ 0x7f, 0xff, 0x7f, 0xde, 0x7b, 0xde, 0x7b, 0x52, 0x4a, 0xff, 0x7f, 0x19, 0x67, 0xef, 0x3d, 0xff,  // ....{.{RJ...g.=.
/* 00c0 */ 0x7f, 0xf7, 0x5e, 0xae, 0x39, 0xde, 0x7b, 0xde, 0x7b, 0x12, 0x8e, 0xff, 0x7f, 0xbe, 0x77, 0x94,  // ..^.9.{.{.....w.
/* 00d0 */ 0x52, 0xff, 0x7f, 0xff, 0x7f, 0x9c, 0x73, 0xff, 0x7f, 0x39, 0x67, 0x10, 0x42, 0xff, 0x7f, 0x18,  // R.....s..9g.B...
/* 00e0 */ 0x63, 0xcf, 0x39, 0xff, 0x7f, 0xff, 0x7f, 0x13, 0x84, 0xd6, 0x5a, 0x11, 0x42, 0x7b, 0x6f, 0x7b,  // c.9.......Z.B{o{
/* 00f0 */ 0x6f, 0x69, 0xff, 0x7f, 0x12, 0x8c, 0x7b, 0x6f, 0x74, 0x4e, 0x52, 0x4a, 0x94, 0x4e, 0x94, 0x4e,  // oi....{otNRJ.N.N
/* 0100 */ 0xbd, 0x77, 0xf7, 0x5e, 0x94, 0x52, 0x9d, 0x73, 0xd6, 0x5a, 0x73, 0x4e, 0x9c, 0x73, 0xd0, 0x33,  // .w.^.R.s.ZsN.s.3
/* 0110 */ 0x08, 0x21, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8e, 0xd6, 0x5a, 0x94, 0x52, 0x94, 0x52,  // .!.........Z.R.R
/* 0120 */ 0x73, 0x4a, 0x73, 0x4a, 0x31, 0x46, 0x31, 0x46, 0x11, 0x42, 0xf0, 0x3d, 0xf0, 0x3d, 0xf0, 0x3d,  // sJsJ1F1F.B.=.=.=
/* 0130 */ 0xce, 0x39, 0xf0, 0x3d, 0xf0, 0x3d, 0x12, 0x8e, 0x18, 0x63, 0xb5, 0x52, 0x94, 0x52, 0x74, 0x4e,  // .9.=.=...c.R.RtN
/* 0140 */ 0x74, 0x4e, 0x73, 0x4e, 0x53, 0x4a, 0x52, 0x4a, 0x32, 0x46, 0x31, 0x46, 0x11, 0x42, 0x10, 0x42,  // tNsNSJRJ2F1F.B.B
/* 0150 */ 0x31, 0x46, 0x31, 0x46, 0x12, 0x8e, 0x9c, 0x6f, 0x18, 0x63, 0x18, 0x5f, 0xf7, 0x5e, 0xf7, 0x5e,  // 1F1F...o.c._.^.^
/* 0160 */ 0xd6, 0x5a, 0xb6, 0x56, 0xb5, 0x52, 0x94, 0x52, 0x74, 0x4e, 0x73, 0x4e, 0x53, 0x4a, 0x74, 0x4e,  // .Z.V.R.RtNsNSJtN
/* 0170 */ 0x74, 0x4e, 0x11, 0x81, 0x59, 0x6b, 0x6e, 0x29, 0x25, 0x81, 0x59, 0x6b, 0x11, 0x72, 0x59, 0x6b,  // tN..Ykn)%.Yk.rYk
/* 0180 */ 0x08, 0x84, 0xb4, 0x1d, 0xb4, 0x1d, 0xb4, 0x1d, 0xb4, 0x1d,                    // ..........
    };

    const BGRPalette palette = make_bgr_palette_from_bgrx_array(raw_palette);

    Bitmap bmp(BitsPerPixel{15}, BitsPerPixel{15}, &palette, 32, 32, raw_bitmap, sizeof(raw_bitmap), true);

    // red square
    gd.mem_blt(Rect(5, 5, 20, 20), bmp, 0, 0);
    RED_CHECK_IMG(gd, IMG_TEST_PATH "mem_blt_3.png");
}

RED_AUTO_TEST_CASE(TestMemblt4)
{
    uint16_t width = 6;
    uint16_t height = 6;
    Rect screen_rect(0, 0, width, height);

    Drawable gd(width, height);
    gd.opaquerect(screen_rect, gd.u32bgr_to_color(0x2F2F2F));

    uint8_t bitmap_bytes[] = {
        0x01, 0x02, 0x03, 0xff,  0x04, 0x05, 0x06, 0xff,  0x07, 0x08, 0x09, 0xff,  0x0a, 0x0b, 0x0c, 0xff,
        0x11, 0x12, 0x13, 0xff,  0x14, 0x15, 0x16, 0xff,  0x17, 0x18, 0x19, 0xff,  0x1a, 0x1b, 0x1c, 0xff,
        0x21, 0x22, 0x23, 0xff,  0x24, 0x25, 0x26, 0xff,  0x27, 0x28, 0x29, 0xff,  0x2a, 0x2b, 0x2c, 0xff,
        0x31, 0x32, 0x33, 0xff,  0x34, 0x35, 0x36, 0xff,  0x37, 0x38, 0x39, 0xff,  0x3a, 0x3b, 0x3c, 0xff
    };
    Rect bitmapRect(1, 1, 4, 4);

    ConstImageDataView imgView(bitmap_bytes, 4, 4, 16, BitsPerPixel{32}, ConstImageDataView::Storage::TopToBottom, nullptr);
    gd.draw_bitmap(bitmapRect, imgView);

    uint8_t expected[] = {
        0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F,
        0x2F, 0x2F, 0x2F, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x2F, 0x2F, 0x2F,
        0x2F, 0x2F, 0x2F, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x2F, 0x2F, 0x2F,
        0x2F, 0x2F, 0x2F, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2F, 0x2F, 0x2F,
        0x2F, 0x2F, 0x2F, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x2F, 0x2F, 0x2F,
        0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F
    };

    RED_CHECK(memcmp(gd.data(), expected, sizeof(expected)) == 0);
    // uncomment to see result in png file
    //dump_png24("./test_memblt4_", gd);
}

//RED_AUTO_TEST_CASE(test_BitArray2D)
//{
//    Pointer p = drawable_default_pointer(false);
////    auto av     = p.get_24bits_xor_mask();
//    auto avmask = p.get_monochrome_and_mask();
//
//    Array2D a2d(4, 32, avmask.data());
//    for (auto x : a2d){
//        BitArray ba(32, x);
//        for (auto bit : ba){
//            printf("%s", bit?"1":"0");
//        }
//        printf("\n");
//    }
//}

// Detect TS_BITMAP_DATA(Uncompressed bitmap data) + (Compressed)bitmapDataStream
RED_AUTO_TEST_CASE(TestBitmapUpate)
{
    uint8_t raw_palette[] = {
/* 0000 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0010 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0020 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0030 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0040 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0050 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0060 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0070 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0080 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0090 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00a0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00b0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00c0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00d0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00e0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00f0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0100 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0110 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0120 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0130 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0140 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0150 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0160 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0170 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0180 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0190 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01a0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01b0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01c0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01d0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01e0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01f0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0200 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0210 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0220 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0230 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0240 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0250 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0260 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0270 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0280 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0290 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02a0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02b0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02c0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02d0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02e0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02f0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0300 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0310 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0320 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0330 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0340 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0350 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0360 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0370 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0380 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0390 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03a0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03b0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03c0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03d0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03e0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03f0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
    };
    uint8_t raw_bitmap[] = {
/* 0000 */ "\x0c\x96\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x51\x8c\x8e\x73" // ............Q..s
/* 0010 */ "\x8e\x73\x8e\x73\x8e\x73\x8e\x73\x8e\x73\x6d\x6b\x6d\x6b\x6d\x6b" // .s.s.s.s.smkmkmk
/* 0020 */ "\x6d\x6b\x30\x84\x30\x84\x30\x84\x00\x00\xd3\x9c\xf7\xbd\x6c\xba" // mk0.0.0.......l.
/* 0030 */ "\xd6\x9f\xf7\xbd\x30\x84\xd3\x9c\xba\xd6\x92\x94\xcf\x7b\x92\x94" // ....0........{..
/* 0040 */ "\xcf\x7b\xcf\x7b\xcf\x7b\xcf\x7b\xcf\x7b\xcf\x7b\x92\x94\xcf\x7b" // .{.{.{.{.{.{...{
/* 0050 */ "\x92\x94\xba\xd6\x30\x84\xd3\x9c\xba\xd6\x92\x94\x7d\xef\x92\x94" // ....0.......}...
/* 0060 */ "\x7d\xef\x7d\xef\x7d\xef\x7d\xef\x7d\xef\x7d\xef\x92\x94\x7d\xef" // }.}.}.}.}.}...}.
/* 0070 */ "\x06\x81\xcf\x7b\xe5\xcf\x7b\x92\x94\x05\x81\x7d\xef\xe5\x7d\xef" // ...{..{....}..}.
/* 0080 */ "\x92\x94\x05\x6b\x92\x94\x03\x81\xf7\xbd\xcc\x28\x42\x86\xf7\xbd" // ...k.......(B...
/* 0090 */ "\x51\x8c\x00\x00\xd3\x9c\x30\x84\x51\x8c\xc9\x69\x4a\x87\x92\x94" // Q.....0.Q..iJ...
/* 00a0 */ "\xd3\x9c\x00\x00\x00\x00\x00\x00\x92\x94\x14\xa5\x6f\x00\x00\x89" // ............o...
/* 00b0 */ "\xd3\x9c\x14\xa5\x00\x00\x00\x00\x00\x00\x14\xa5\x14\xa5\x14\xa5" // ................
/* 00c0 */ "\x14\xa5\x68\x00\x00\x89\x92\x94\xd3\x9c\x14\xa5\xd3\x9c\x92\x94" // ..h.............
/* 00d0 */ "\x92\x94\x92\x94\x92\x94\xd3\x9c\x68\x00\x00\x89\x51\x8c\x92\x94" // ........h...Q...
/* 00e0 */ "\x51\x8c\xb6\xb5\x00\x00\x00\x00\x00\x00\x51\x8c\x14\xa5\x6f\x00" // Q.........Q...o.
/* 00f0 */ "\x00\x81\x51\x8c\x0e\x84\x00\x00\x00\x00\x00\x00\x00"          // ..Q...........
    };

    const BGRPalette palette = make_bgr_palette_from_bgrx_array(raw_palette);

    Bitmap bmp(BitsPerPixel{16}, BitsPerPixel{16}, &palette, 16, 16, raw_bitmap, 254, true);
    // dump_png24("./test_mouse_001_.png", bmp, true);

    Bitmap bmp2(BitsPerPixel{16}, BitsPerPixel{16}, &palette, 16, 16, bmp.data(), bmp.bmp_size(), false);

    StaticOutStream<1024> out;
    bmp2.compress(BitsPerPixel{16}, out);

    RED_CHECK(bmp.data_compressed() == make_array_view(raw_bitmap));
}
